<!-- SEO Scan Results - SEMrush-Inspired Professional Design -->
<div class="sr-scan-results">
    {% if scan %}
    
    <!-- Header Section -->
    <div class="container-fluid">
        <div class="sr-header sr-fade-in">
            <div class="sr-header-top">
                <div class="sr-header-content">
                    <h1>Analisi SEO: {{ scan.website_name }}</h1>
                    <p class="sr-header-subtitle">
                        Cliente: <strong>{{ scan.client_name }}</strong> • 
                        Scansione #{{ scan.id }} • 
                        {% if scan.completed_at %}
                        Completata il {{ scan.completed_at.strftime('%d/%m/%Y alle %H:%M') }}
                        {% else %}
                        In corso...
                        {% endif %}
                    </p>
                    <div class="sr-header-meta">
                        <div class="sr-meta-item">
                            <i class="bi bi-{{ 'check-circle' if scan.status == 'completed' else 'clock' if scan.status == 'running' else 'x-circle' }} sr-meta-icon"></i>
                            <span>Status: <strong>{{ scan.status.title() }}</strong></span>
                        </div>
                        <div class="sr-meta-item">
                            <i class="bi bi-calendar3 sr-meta-icon"></i>
                            <span>Avviata: {{ scan.created_at.strftime('%d/%m/%Y %H:%M') if scan.created_at else 'N/A' }}</span>
                        </div>
                        <div class="sr-meta-item">
                            <i class="bi bi-stopwatch sr-meta-icon"></i>
                            <span>
                                {% if scan.completed_at and scan.created_at %}
                                Durata: {{ ((scan.completed_at - scan.created_at).total_seconds() / 60) | round(1) }} min
                                {% else %}
                                In corso...
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="sr-header-actions">
                    <a href="/api/v1/scans/{{ scan.id }}/report" class="sr-btn sr-btn-primary" target="_blank">
                        <i class="bi bi-download"></i>
                        Scarica Report PDF
                    </a>
                    <a href="/templated/scans" class="sr-btn sr-btn-outline">
                        <i class="bi bi-arrow-left"></i>
                        Torna alle Scansioni
                    </a>
                </div>
            </div>
        </div>

        <!-- Key Metrics Dashboard -->
        <div class="sr-metrics sr-fade-in">
            <!-- Pages Scanned -->
            <div class="sr-metric-card">
                <div class="sr-metric-header">
                    <div class="sr-metric-icon pages">
                        <i class="bi bi-files"></i>
                    </div>
                    {% if scan.seo_score %}
                    <div class="sr-score-display">
                        <div class="sr-score-circle {{ 'excellent' if scan.seo_score >= 80 else 'good' if scan.seo_score >= 60 else 'fair' if scan.seo_score >= 40 else 'poor' }}">
                            {{ scan.seo_score }}
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="sr-metric-value">{{ pages|length }}</div>
                <div class="sr-metric-label">Pagine Scansionate</div>
                {% if scan.pages_scanned and scan.pages_scanned != pages|length %}
                <div class="sr-metric-trend">{{ scan.pages_scanned }} trovate totali</div>
                {% endif %}
            </div>

            <!-- Total Issues -->
            <div class="sr-metric-card">
                <div class="sr-metric-header">
                    <div class="sr-metric-icon issues">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                </div>
                <div class="sr-metric-value">{{ issues|length }}</div>
                <div class="sr-metric-label">Problemi Totali</div>
                {% set issues_per_page = (issues|length / (pages|length if pages|length > 0 else 1)) | round(1) %}
                <div class="sr-metric-trend">{{ issues_per_page }} problemi/pagina</div>
            </div>

            <!-- Critical Issues -->
            <div class="sr-metric-card">
                <div class="sr-metric-header">
                    <div class="sr-metric-icon critical">
                        <i class="bi bi-shield-exclamation"></i>
                    </div>
                </div>
                {% set critical_issues = issues|selectattr('severity', 'equalto', 'critical')|list|length %}
                <div class="sr-metric-value">{{ critical_issues }}</div>
                <div class="sr-metric-label">Problemi Critici</div>
                {% if critical_issues > 0 %}
                <div class="sr-metric-trend sr-text-danger">Richiede attenzione immediata</div>
                {% else %}
                <div class="sr-metric-trend sr-text-success">Nessun problema critico</div>
                {% endif %}
            </div>

            <!-- Performance Score -->
            <div class="sr-metric-card">
                <div class="sr-metric-header">
                    <div class="sr-metric-icon score">
                        <i class="bi bi-speedometer2"></i>
                    </div>
                </div>
                {% set avg_score = (pages|selectattr('seo_score')|map(attribute='seo_score')|sum / (pages|selectattr('seo_score')|list|length if pages|selectattr('seo_score')|list|length > 0 else 1)) | round(1) %}
                <div class="sr-metric-value">{{ avg_score if pages|selectattr('seo_score')|list|length > 0 else 'N/A' }}</div>
                <div class="sr-metric-label">Score Medio Pagine</div>
                {% if pages|selectattr('seo_score')|list|length > 0 %}
                <div class="sr-metric-trend">
                    {{ pages|selectattr('seo_score')|selectattr('seo_score', 'ge', 80)|list|length }} pagine eccellenti
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Issues Analysis Section -->
        <div class="sr-section sr-fade-in">
            <div class="sr-section-header">
                <h2 class="sr-section-title">
                    <i class="bi bi-bug"></i>
                    Analisi Problemi SEO
                </h2>
                <p class="sr-section-subtitle">
                    Problemi rilevati categorizzati per severità e tipo. Totale: {{ issues|length }} problemi
                </p>
            </div>
            
            <div class="sr-section-body">
                {% if issues %}
                <!-- Issues Breakdown -->
                <div style="padding: 1.5rem; background: var(--sr-gray-50); border-bottom: 1px solid var(--sr-border);">
                    <div class="row">
                        <div class="col-md-3 col-6 mb-3">
                            <div class="text-center">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--sr-danger);">
                                    {{ issues|selectattr('severity', 'equalto', 'critical')|list|length }}
                                </div>
                                <div style="font-size: 0.875rem; color: var(--sr-text-muted);">Critici</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="text-center">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--sr-warning);">
                                    {{ issues|selectattr('severity', 'equalto', 'high')|list|length }}
                                </div>
                                <div style="font-size: 0.875rem; color: var(--sr-text-muted);">Alti</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="text-center">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--sr-info);">
                                    {{ issues|selectattr('severity', 'equalto', 'medium')|list|length }}
                                </div>
                                <div style="font-size: 0.875rem; color: var(--sr-text-muted);">Medi</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="text-center">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--sr-success);">
                                    {{ issues|selectattr('severity', 'equalto', 'low')|list|length }}
                                </div>
                                <div style="font-size: 0.875rem; color: var(--sr-text-muted);">Bassi</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="sr-table">
                        <thead>
                            <tr>
                                <th style="width: 15%;">Tipo</th>
                                <th style="width: 12%;">Severità</th>
                                <th style="width: 45%;">Descrizione</th>
                                <th style="width: 28%;">Pagina Coinvolta</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for issue in issues|sort(attribute='severity', reverse=true) %}
                            <tr>
                                <td>
                                    <div style="font-weight: 500; color: var(--sr-text);">
                                        {{ issue.type.replace('_', ' ').title() }}
                                    </div>
                                </td>
                                <td>
                                    <span class="sr-badge {{ issue.severity }}">
                                        <i class="bi bi-{{ 'exclamation-circle' if issue.severity == 'critical' else 'exclamation-triangle' if issue.severity == 'high' else 'info-circle' if issue.severity == 'medium' else 'check-circle' }}"></i>
                                        {{ issue.severity.title() }}
                                    </span>
                                </td>
                                <td>
                                    <div style="line-height: 1.4;">{{ issue.message }}</div>
                                </td>
                                <td>
                                    <a href="{{ issue.page_url }}" target="_blank" class="sr-url" title="{{ issue.page_url }}">
                                        {{ issue.page_url }}
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="sr-empty-state">
                    <div class="sr-empty-icon">
                        <i class="bi bi-check-circle-fill sr-text-success"></i>
                    </div>
                    <h3 class="sr-empty-title">Nessun Problema Rilevato</h3>
                    <p class="sr-empty-description">
                        Eccellente! Il sito non presenta problemi SEO significativi.
                    </p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Pages Performance Section -->
        <div class="sr-section sr-fade-in">
            <div class="sr-section-header">
                <h2 class="sr-section-title">
                    <i class="bi bi-speedometer2"></i>
                    Performance delle Pagine
                </h2>
                <p class="sr-section-subtitle">
                    Analisi dettagliata delle {{ pages|length }} pagine scansionate con score SEO e problemi per pagina
                </p>
            </div>
            
            <div class="sr-section-body">
                {% if pages %}
                <div class="table-responsive">
                    <table class="sr-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">URL</th>
                                <th style="width: 25%;">Titolo Pagina</th>
                                <th style="width: 10%;">Status</th>
                                <th style="width: 15%;">Score SEO</th>
                                <th style="width: 10%;">Problemi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for page in pages|sort(attribute='seo_score', reverse=true) %}
                            <tr>
                                <td>
                                    <a href="{{ page.url }}" target="_blank" class="sr-url" title="{{ page.url }}">
                                        {{ page.url }}
                                    </a>
                                </td>
                                <td>
                                    <div class="sr-truncate" style="max-width: 200px;" title="{{ page.title or 'Nessun titolo' }}">
                                        {{ page.title or 'Nessun titolo' }}
                                    </div>
                                </td>
                                <td>
                                    <span class="sr-badge status-{{ page.status_code if page.status_code else '000' }}">
                                        {{ page.status_code or '000' }}
                                    </span>
                                </td>
                                <td>
                                    {% if page.seo_score %}
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <div class="sr-progress" style="width: 50px;">
                                            <div class="sr-progress-bar {{ 'excellent' if page.seo_score >= 80 else 'good' if page.seo_score >= 60 else 'fair' if page.seo_score >= 40 else 'poor' }}" 
                                                 style="width: {{ page.seo_score }}%;"></div>
                                        </div>
                                        <span style="font-weight: 500; min-width: 35px;">{{ page.seo_score }}</span>
                                    </div>
                                    {% else %}
                                    <span class="sr-text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if page.issues_count > 0 %}
                                    <span class="sr-badge {{ 'critical' if page.issues_count >= 10 else 'high' if page.issues_count >= 5 else 'medium' }}">
                                        {{ page.issues_count }}
                                    </span>
                                    {% else %}
                                    <span class="sr-badge low">
                                        <i class="bi bi-check"></i> 0
                                    </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="sr-empty-state">
                    <div class="sr-empty-icon">
                        <i class="bi bi-file-earmark-x"></i>
                    </div>
                    <h3 class="sr-empty-title">Nessuna Pagina Scansionata</h3>
                    <p class="sr-empty-description">
                        La scansione potrebbe essere ancora in corso o non è riuscita a trovare pagine.
                    </p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Actions & Summary -->
        <div class="sr-section sr-fade-in">
            <div class="sr-section-header">
                <h2 class="sr-section-title">
                    <i class="bi bi-lightning"></i>
                    Prossimi Passi Consigliati
                </h2>
                <p class="sr-section-subtitle">
                    Azioni prioritarie basate sui risultati della scansione
                </p>
            </div>
            
            <div class="sr-section-body" style="padding: 1.5rem;">
                {% set critical_count = issues|selectattr('severity', 'equalto', 'critical')|list|length %}
                {% set high_count = issues|selectattr('severity', 'equalto', 'high')|list|length %}
                
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h4 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: var(--sr-text);">
                            <i class="bi bi-star"></i> Priorità Alta
                        </h4>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            {% if critical_count > 0 %}
                            <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--sr-border);">
                                <i class="bi bi-exclamation-triangle" style="color: var(--sr-danger); margin-right: 0.5rem;"></i>
                                Risolvere {{ critical_count }} problema{{ 's' if critical_count != 1 else '' }} critico{{ 's' if critical_count != 1 else '' }}
                            </li>
                            {% endif %}
                            {% if high_count > 0 %}
                            <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--sr-border);">
                                <i class="bi bi-exclamation-circle" style="color: var(--sr-warning); margin-right: 0.5rem;"></i>
                                Gestire {{ high_count }} problema{{ 's' if high_count != 1 else '' }} ad alta priorità
                            </li>
                            {% endif %}
                            {% if not critical_count and not high_count %}
                            <li style="padding: 0.5rem 0;">
                                <i class="bi bi-check-circle" style="color: var(--sr-success); margin-right: 0.5rem;"></i>
                                Nessun problema critico o ad alta priorità
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                        <h4 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: var(--sr-text);">
                            <i class="bi bi-graph-up"></i> Ottimizzazioni
                        </h4>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            {% set low_score_pages = pages|selectattr('seo_score')|selectattr('seo_score', 'lt', 60)|list|length %}
                            {% if low_score_pages > 0 %}
                            <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--sr-border);">
                                <i class="bi bi-speedometer" style="color: var(--sr-info); margin-right: 0.5rem;"></i>
                                Migliorare {{ low_score_pages }} pagina{{ 's' if low_score_pages != 1 else '' }} con score basso
                            </li>
                            {% endif %}
                            <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--sr-border);">
                                <i class="bi bi-download" style="color: var(--sr-primary); margin-right: 0.5rem;"></i>
                                Scaricare il report PDF completo
                            </li>
                            <li style="padding: 0.5rem 0;">
                                <i class="bi bi-arrow-repeat" style="color: var(--sr-info); margin-right: 0.5rem;"></i>
                                Programmare scansione di follow-up
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--sr-border); text-align: center;">
                    <a href="/api/v1/scans/{{ scan.id }}/report" class="sr-btn sr-btn-primary" target="_blank" style="margin-right: 1rem;">
                        <i class="bi bi-download"></i>
                        Scarica Report Completo
                    </a>
                    <a href="/templated/scans" class="sr-btn sr-btn-outline">
                        <i class="bi bi-plus-circle"></i>
                        Avvia Nuova Scansione
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Error State -->
    <div class="container-fluid">
        <div class="sr-section">
            <div class="sr-empty-state">
                <div class="sr-empty-icon">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <h3 class="sr-empty-title">Scansione Non Trovata</h3>
                <p class="sr-empty-description">
                    La scansione richiesta non esiste o non è più accessibile.
                </p>
                <div style="margin-top: 2rem;">
                    <a href="/templated/scans" class="sr-btn sr-btn-primary">
                        <i class="bi bi-arrow-left"></i>
                        Torna alle Scansioni
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Include dedicated CSS -->
<link rel="stylesheet" href="/static/css/scan-results-semrush.css">

<script>
// Simple JavaScript for enhanced UX
document.addEventListener('DOMContentLoaded', function() {
    // Add fade-in animation delays
    const elements = document.querySelectorAll('.sr-fade-in');
    elements.forEach((el, index) => {
        el.style.animationDelay = `${index * 0.1}s`;
    });
    
    // Add hover effects for metric cards
    const metricCards = document.querySelectorAll('.sr-metric-card');
    metricCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-4px)';
            this.style.boxShadow = 'var(--sr-shadow-lg)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '';
        });
    });
    
    // Smooth scroll for internal links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});
</script>