<!-- SEO Scan Results - SEMrush-Inspired Professional Design -->
<div class="sr-scan-results">
    {% if scan %}
    
    <!-- Header Section -->
    <div class="container-fluid">
        <div class="sr-header sr-fade-in">
            <div class="sr-header-top">
                <div class="sr-header-content">
                    <h1>Analisi SEO: {{ scan.website_name }}</h1>
                    <p class="sr-header-subtitle">
                        Cliente: <strong>{{ scan.client_name }}</strong> • 
                        Scansione #{{ scan.id }} • 
                        {% if scan.completed_at %}
                        Completata il {{ scan.completed_at.strftime('%d/%m/%Y alle %H:%M') }}
                        {% else %}
                        In corso...
                        {% endif %}
                    </p>
                    <div class="sr-header-meta">
                        <div class="sr-meta-item">
                            <i class="bi bi-{{ 'check-circle' if scan.status == 'completed' else 'clock' if scan.status == 'running' else 'x-circle' }} sr-meta-icon"></i>
                            <span>Status: <strong>{{ scan.status.title() }}</strong></span>
                        </div>
                        <div class="sr-meta-item">
                            <i class="bi bi-calendar3 sr-meta-icon"></i>
                            <span>Avviata: {{ scan.created_at.strftime('%d/%m/%Y %H:%M') if scan.created_at else 'N/A' }}</span>
                        </div>
                        <div class="sr-meta-item">
                            <i class="bi bi-stopwatch sr-meta-icon"></i>
                            <span>
                                {% if scan.completed_at and scan.created_at %}
                                Durata: {{ ((scan.completed_at - scan.created_at).total_seconds() / 60) | round(1) }} min
                                {% else %}
                                In corso...
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="sr-header-actions">
                    <a href="/api/v1/scans/{{ scan.id }}/report" class="sr-btn sr-btn-primary" target="_blank">
                        <i class="bi bi-download"></i>
                        Scarica Report PDF
                    </a>
                    <a href="/templated/scans" class="sr-btn sr-btn-outline">
                        <i class="bi bi-arrow-left"></i>
                        Torna alle Scansioni
                    </a>
                </div>
            </div>
        </div>

        <!-- Key Metrics Dashboard -->
        <div class="sr-metrics sr-fade-in">
            <!-- Pages Scanned -->
            <div class="sr-metric-card">
                <div class="sr-metric-header">
                    <div class="sr-metric-icon pages">
                        <i class="bi bi-files"></i>
                    </div>
                    {% if scan.seo_score %}
                    <div class="sr-score-display">
                        <div class="sr-score-circle {{ 'excellent' if scan.seo_score >= 80 else 'good' if scan.seo_score >= 60 else 'fair' if scan.seo_score >= 40 else 'poor' }}">
                            {{ scan.seo_score }}
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="sr-metric-value">{{ pages|length }}</div>
                <div class="sr-metric-label">Pagine Scansionate</div>
                {% if scan.pages_scanned and scan.pages_scanned != pages|length %}
                <div class="sr-metric-trend">{{ scan.pages_scanned }} trovate totali</div>
                {% endif %}
            </div>

            <!-- Total Issues -->
            <div class="sr-metric-card">
                <div class="sr-metric-header">
                    <div class="sr-metric-icon issues">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                </div>
                <div class="sr-metric-value">{{ issues|length }}</div>
                <div class="sr-metric-label">Problemi Totali</div>
                {% set issues_per_page = (issues|length / (pages|length if pages|length > 0 else 1)) | round(1) %}
                <div class="sr-metric-trend">{{ issues_per_page }} problemi/pagina</div>
            </div>

            <!-- Critical Issues -->
            <div class="sr-metric-card">
                <div class="sr-metric-header">
                    <div class="sr-metric-icon critical">
                        <i class="bi bi-shield-exclamation"></i>
                    </div>
                </div>
                {% set critical_issues = issues|selectattr('severity', 'equalto', 'critical')|list|length %}
                <div class="sr-metric-value">{{ critical_issues }}</div>
                <div class="sr-metric-label">Problemi Critici</div>
                {% if critical_issues > 0 %}
                <div class="sr-metric-trend sr-text-danger">Richiede attenzione immediata</div>
                {% else %}
                <div class="sr-metric-trend sr-text-success">Nessun problema critico</div>
                {% endif %}
            </div>

            <!-- Performance Score -->
            <div class="sr-metric-card">
                <div class="sr-metric-header">
                    <div class="sr-metric-icon score">
                        <i class="bi bi-speedometer2"></i>
                    </div>
                </div>
                {% set avg_score = (pages|selectattr('seo_score')|map(attribute='seo_score')|sum / (pages|selectattr('seo_score')|list|length if pages|selectattr('seo_score')|list|length > 0 else 1)) | round(1) %}
                <div class="sr-metric-value">{{ avg_score if pages|selectattr('seo_score')|list|length > 0 else 'N/A' }}</div>
                <div class="sr-metric-label">Score Medio Pagine</div>
                {% if pages|selectattr('seo_score')|list|length > 0 %}
                <div class="sr-metric-trend">
                    {{ pages|selectattr('seo_score')|selectattr('seo_score', 'ge', 80)|list|length }} pagine eccellenti
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Issues Analysis Section -->
        <div class="sr-section sr-fade-in">
            <div class="sr-section-header">
                <h2 class="sr-section-title">
                    <i class="bi bi-bug"></i>
                    Analisi Problemi SEO
                </h2>
                <p class="sr-section-subtitle">
                    Problemi rilevati categorizzati per severità e tipo. Totale: {{ issues|length }} problemi
                </p>
            </div>
            
            <div class="sr-section-body">
                {% if issues %}
                <!-- Issues Breakdown -->
                <div style="padding: 1.5rem; background: var(--sr-gray-50); border-bottom: 1px solid var(--sr-border);">
                    <div class="row">
                        <div class="col-md-3 col-6 mb-3">
                            <div class="text-center">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--sr-danger);">
                                    {{ issues|selectattr('severity', 'equalto', 'critical')|list|length }}
                                </div>
                                <div style="font-size: 0.875rem; color: var(--sr-text-muted);">Critici</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="text-center">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--sr-warning);">
                                    {{ issues|selectattr('severity', 'equalto', 'high')|list|length }}
                                </div>
                                <div style="font-size: 0.875rem; color: var(--sr-text-muted);">Alti</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="text-center">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--sr-info);">
                                    {{ issues|selectattr('severity', 'equalto', 'medium')|list|length }}
                                </div>
                                <div style="font-size: 0.875rem; color: var(--sr-text-muted);">Medi</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="text-center">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--sr-success);">
                                    {{ issues|selectattr('severity', 'equalto', 'low')|list|length }}
                                </div>
                                <div style="font-size: 0.875rem; color: var(--sr-text-muted);">Bassi</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Issues by Severity with NESTED ACCORDION -->
                <div class="sr-issues-content" style="padding: 1.5rem;">
                    {% set severity_order = ['critical', 'high', 'medium', 'low'] %}
                    {% set severity_names = {'critical': 'Critici', 'high': 'Alta Priorità', 'medium': 'Media Priorità', 'low': 'Bassa Priorità'} %}
                    {% set severity_icons = {'critical': 'exclamation-circle', 'high': 'exclamation-triangle', 'medium': 'info-circle', 'low': 'check-circle'} %}
                    
                    {% for severity in severity_order %}
                        {% if issues_hierarchy.get(severity) %}
                        <div class="accordion-item" style="margin-bottom: 1rem;">
                            <!-- LEVEL 1: Severity Accordion -->
                            <div class="accordion-header" onclick="toggleAccordion('severity-{{ severity }}')" 
                                 style="background: var(--sr-gray-50); border: 1px solid var(--sr-border); border-radius: 8px; padding: 1rem; cursor: pointer; user-select: none;">
                                <div style="display: flex; justify-content: between; align-items: center;">
                                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                                        <span class="sr-badge {{ severity }}">
                                            <i class="bi bi-{{ severity_icons[severity] }}"></i>
                                            {{ severity_names[severity] }}
                                        </span>
                                        {% set total_issues_in_severity = issues_hierarchy[severity].values() | map(attribute='count') | sum %}
                                        <span style="font-weight: 600; color: var(--sr-text);">
                                            {{ total_issues_in_severity }} problema{{ 'i' if total_issues_in_severity != 1 else '' }}
                                        </span>
                                        <!-- Show issue types preview -->
                                        <span style="font-size: 0.875rem; color: var(--sr-text-muted);">
                                            ({{ issues_hierarchy[severity].keys() | length }} tipologie)
                                        </span>
                                    </div>
                                    <i class="bi bi-chevron-down accordion-icon" id="icon-severity-{{ severity }}" style="transition: transform 0.2s;"></i>
                                </div>
                            </div>
                            
                            <!-- LEVEL 2: Issue Types Nested Accordion -->
                            <div class="accordion-content" id="content-severity-{{ severity }}" style="display: none; border: 1px solid var(--sr-border); border-top: none; border-radius: 0 0 8px 8px; background: var(--sr-white);">
                                {% for issue_type, issue_data in issues_hierarchy[severity].items() %}
                                <div class="nested-accordion-item" style="margin: 0.5rem; border: 1px solid var(--sr-border-light); border-radius: 6px;">
                                    <!-- Issue Type Header -->
                                    <div class="nested-accordion-header" onclick="toggleNestedAccordion('{{ severity }}-{{ issue_type }}')" 
                                         style="background: var(--sr-gray-25); padding: 0.75rem; cursor: pointer; user-select: none; border-radius: 6px 6px 0 0;">
                                        <div style="display: flex; justify-content: between; align-items: center;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <i class="{{ issue_data.icon }}" style="color: var(--sr-primary); font-size: 1rem;"></i>
                                                <span style="font-weight: 500; color: var(--sr-text); font-size: 0.9rem;">
                                                    {{ issue_data.title }}
                                                </span>
                                                <span class="sr-badge {{ severity }}" style="font-size: 0.75rem; padding: 0.125rem 0.375rem;">
                                                    {{ issue_data.count }} pagina{{ 'e' if issue_data.count != 1 else '' }}
                                                </span>
                                            </div>
                                            <i class="bi bi-chevron-down accordion-icon" id="icon-nested-{{ severity }}-{{ issue_type }}" style="transition: transform 0.2s; font-size: 0.875rem;"></i>
                                        </div>
                                        
                                        <!-- Issue Description Preview -->
                                        {% if issue_data.first_description %}
                                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--sr-text-muted); line-height: 1.3;">
                                            {{ issue_data.first_description[:100] }}{% if issue_data.first_description|length > 100 %}...{% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Pages List -->
                                    <div class="nested-accordion-content" id="content-nested-{{ severity }}-{{ issue_type }}" 
                                         style="display: none; padding: 0.75rem; background: var(--sr-white); border-top: 1px solid var(--sr-border-light); border-radius: 0 0 6px 6px;">
                                        
                                        <!-- Description and Recommendation -->
                                        {% if issue_data.first_description or issue_data.first_recommendation %}
                                        <div style="margin-bottom: 0.75rem; padding: 0.5rem; background: var(--sr-gray-25); border-radius: 4px; border-left: 3px solid var(--sr-{{ severity }});">
                                            {% if issue_data.first_description %}
                                            <div style="font-size: 0.85rem; color: var(--sr-text); margin-bottom: 0.25rem;">
                                                <strong>Problema:</strong> {{ issue_data.first_description }}
                                            </div>
                                            {% endif %}
                                            {% if issue_data.first_recommendation %}
                                            <div style="font-size: 0.85rem; color: var(--sr-text-muted);">
                                                <strong>Soluzione:</strong> {{ issue_data.first_recommendation }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Enhanced Resource Details Table -->
                                        {% if issue_data.resource_details %}
                                        <div style="font-size: 0.875rem; font-weight: 500; color: var(--sr-text); margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
                                            <span>Risorse Interessate: ({{ issue_data.resource_details|length }})</span>
                                            <div class="sr-table-controls" style="display: flex; gap: 0.5rem; align-items: center;">
                                                <label style="font-size: 0.75rem; color: var(--sr-text-muted);">Ordina per:</label>
                                                <select class="sr-sort-select" onchange="sortResourceTable(this, '{{ severity }}-{{ issue_type }}')" style="font-size: 0.75rem; padding: 0.25rem; border: 1px solid var(--sr-border); border-radius: 3px;">
                                                    <option value="page">Pagina</option>
                                                    <option value="resource">Risorsa</option>
                                                    <option value="type">Tipo</option>
                                                    <option value="impact">Impatto</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="sr-resource-table-container" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--sr-border-light); border-radius: 4px;">
                                            <table class="sr-resource-table" style="margin: 0; font-size: 0.8rem; width: 100%;" id="resource-table-{{ severity }}-{{ issue_type }}">
                                                <thead style="background: var(--sr-gray-25); position: sticky; top: 0; z-index: 10;">
                                                    <tr>
                                                        <th class="sr-resource-th" style="width: 25%; padding: 0.5rem;">
                                                            <div class="sr-th-content">
                                                                <i class="bi bi-link-45deg" style="margin-right: 0.25rem;"></i>
                                                                Pagina
                                                            </div>
                                                        </th>
                                                        <th class="sr-resource-th" style="width: 30%; padding: 0.5rem;">
                                                            <div class="sr-th-content">
                                                                <i class="bi bi-file-earmark" style="margin-right: 0.25rem;"></i>
                                                                Risorsa
                                                            </div>
                                                        </th>
                                                        <th class="sr-resource-th" style="width: 10%; padding: 0.5rem;">
                                                            <div class="sr-th-content">
                                                                <i class="bi bi-tag" style="margin-right: 0.25rem;"></i>
                                                                Tipo
                                                            </div>
                                                        </th>
                                                        <th class="sr-resource-th" style="width: 20%; padding: 0.5rem;">
                                                            <div class="sr-th-content">
                                                                <i class="bi bi-info-circle" style="margin-right: 0.25rem;"></i>
                                                                Dettagli Specifici
                                                            </div>
                                                        </th>
                                                        <th class="sr-resource-th" style="width: 10%; padding: 0.5rem;">
                                                            <div class="sr-th-content">
                                                                <i class="bi bi-speedometer2" style="margin-right: 0.25rem;"></i>
                                                                Impatto
                                                            </div>
                                                        </th>
                                                        <th class="sr-resource-th" style="width: 5%; padding: 0.5rem; text-align: center;">
                                                            <div class="sr-th-content">
                                                                <i class="bi bi-tools"></i>
                                                            </div>
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for resource in issue_data.resource_details %}
                                                    <tr class="sr-resource-row" style="border-bottom: 1px solid var(--sr-border-light);" data-resource-type="{{ resource.resource_type }}">
                                                        <!-- Page Column -->
                                                        <td class="sr-resource-cell" style="padding: 0.5rem; vertical-align: top;" data-sort-key="{{ resource.page_url }}">
                                                            <a href="{{ resource.page_url }}" target="_blank" class="sr-url sr-page-link" 
                                                               style="font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem; text-decoration: none;"
                                                               title="{{ resource.page_url }}">
                                                                <i class="bi bi-box-arrow-up-right" style="color: var(--sr-text-muted); font-size: 0.7rem; flex-shrink: 0;"></i>
                                                                <span class="sr-url-text">{{ resource.page_url|truncate(35, True, '...') }}</span>
                                                            </a>
                                                            {% if resource.page_context %}
                                                            <div class="sr-page-context" style="font-size: 0.65rem; color: var(--sr-text-muted); margin-top: 0.25rem; padding: 0.125rem 0.25rem; background: var(--sr-gray-25); border-radius: 2px;">
                                                                {{ resource.page_context|truncate(25, True, '...') }}
                                                            </div>
                                                            {% endif %}
                                                        </td>
                                                        
                                                        <!-- Resource Column -->
                                                        <td class="sr-resource-cell" style="padding: 0.5rem; vertical-align: top;" data-sort-key="{{ resource.resource_url }}">
                                                            <div class="sr-resource-info" style="display: flex; align-items: flex-start; gap: 0.25rem;">
                                                                {% set resource_icon_class = {
                                                                    'image': 'bi-image',
                                                                    'css': 'bi-file-earmark-code',
                                                                    'javascript': 'bi-file-earmark-text',
                                                                    'link': 'bi-link',
                                                                    'meta_tag': 'bi-tag',
                                                                    'heading': 'bi-type-h1',
                                                                    'content_block': 'bi-file-text',
                                                                    'form_element': 'bi-ui-checks',
                                                                    'schema_markup': 'bi-code-square'
                                                                }.get(resource.resource_type, 'bi-file-earmark') %}
                                                                {% set resource_color_class = {
                                                                    'image': 'var(--sr-info)',
                                                                    'css': 'var(--sr-primary)',
                                                                    'javascript': 'var(--sr-warning)',
                                                                    'link': 'var(--sr-success)',
                                                                    'meta_tag': 'var(--sr-info)',
                                                                    'heading': 'var(--sr-dark)',
                                                                    'content_block': 'var(--sr-text)',
                                                                    'form_element': 'var(--sr-secondary)',
                                                                    'schema_markup': 'var(--sr-primary)'
                                                                }.get(resource.resource_type, 'var(--sr-text-muted)') %}
                                                                <i class="bi {{ resource_icon_class }}" style="color: {{ resource_color_class }}; font-size: 0.875rem; margin-top: 0.125rem; flex-shrink: 0;"></i>
                                                                <div class="sr-resource-details" style="flex: 1; min-width: 0;">
                                                                    <div class="sr-resource-url" style="font-size: 0.75rem; word-break: break-all; line-height: 1.2;">
                                                                        {% if resource.resource_url|length > 50 %}
                                                                        <span title="{{ resource.resource_url }}">{{ resource.resource_url|truncate(50, True, '...') }}</span>
                                                                        {% else %}
                                                                        {{ resource.resource_url }}
                                                                        {% endif %}
                                                                    </div>
                                                                    {% if resource.issue_specific_data.get('current_filename') %}
                                                                    <div class="sr-filename" style="font-size: 0.65rem; color: var(--sr-text-muted); margin-top: 0.125rem;">
                                                                        <i class="bi bi-file-earmark" style="margin-right: 0.125rem;"></i>
                                                                        {{ resource.issue_specific_data.current_filename }}
                                                                    </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </td>
                                                        
                                                        <!-- Type Column -->
                                                        <td class="sr-resource-cell" style="padding: 0.5rem; vertical-align: top; text-align: center;" data-sort-key="{{ resource.resource_type }}">
                                                            {% set type_badges = {
                                                                'image': {'label': 'IMG', 'class': 'info'},
                                                                'css': {'label': 'CSS', 'class': 'primary'},
                                                                'javascript': {'label': 'JS', 'class': 'warning'},
                                                                'link': {'label': 'LINK', 'class': 'success'},
                                                                'meta_tag': {'label': 'META', 'class': 'info'},
                                                                'heading': {'label': 'H1-6', 'class': 'dark'},
                                                                'content_block': {'label': 'TEXT', 'class': 'secondary'},
                                                                'form_element': {'label': 'FORM', 'class': 'secondary'},
                                                                'schema_markup': {'label': 'JSON', 'class': 'primary'}
                                                            } %}
                                                            {% set badge_info = type_badges.get(resource.resource_type, {'label': 'OTHER', 'class': 'secondary'}) %}
                                                            <span class="sr-badge {{ badge_info.class }}" style="font-size: 0.65rem; padding: 0.125rem 0.375rem; border-radius: 3px;">
                                                                {{ badge_info.label }}
                                                            </span>
                                                        </td>
                                                        
                                                        <!-- Specific Details Column -->
                                                        <td class="sr-resource-cell" style="padding: 0.5rem; vertical-align: top;">
                                                            {% if resource.issue_specific_data %}
                                                            <div class="sr-specific-details" style="font-size: 0.7rem; line-height: 1.3;">
                                                                <!-- Image-specific details -->
                                                                {% if resource.resource_type == 'image' %}
                                                                    {% if resource.issue_specific_data.get('current_alt') is defined %}
                                                                    <div class="sr-detail-item" style="margin-bottom: 0.25rem;">
                                                                        <strong style="color: var(--sr-text);">Alt:</strong>
                                                                        {% if resource.issue_specific_data.current_alt %}
                                                                        <span style="color: var(--sr-success);">"{{ resource.issue_specific_data.current_alt|truncate(25, True, '...') }}"</span>
                                                                        {% else %}
                                                                        <span style="color: var(--sr-danger); font-style: italic;">Missing</span>
                                                                        {% endif %}
                                                                    </div>
                                                                    {% endif %}
                                                                    {% if resource.issue_specific_data.get('current_width') %}
                                                                    <div class="sr-detail-item" style="margin-bottom: 0.25rem;">
                                                                        <strong style="color: var(--sr-text);">Size:</strong>
                                                                        <span>{{ resource.issue_specific_data.current_width }}×{{ resource.issue_specific_data.current_height }}px</span>
                                                                        {% if resource.issue_specific_data.get('file_size_bytes') %}
                                                                        <br><span style="color: var(--sr-text-muted);">{{ (resource.issue_specific_data.file_size_bytes / 1024)|round(1) }}KB</span>
                                                                        {% endif %}
                                                                    </div>
                                                                    {% endif %}
                                                                {% endif %}
                                                                
                                                                <!-- CSS/JS-specific details -->
                                                                {% if resource.resource_type in ['css', 'javascript'] %}
                                                                    {% if resource.issue_specific_data.get('blocking_type') %}
                                                                    <div class="sr-detail-item" style="margin-bottom: 0.25rem;">
                                                                        <strong style="color: var(--sr-text);">Type:</strong>
                                                                        <span style="color: var(--sr-warning);">{{ resource.issue_specific_data.blocking_type.replace('_', ' ').title() }}</span>
                                                                    </div>
                                                                    {% endif %}
                                                                    {% if resource.issue_specific_data.get('load_priority') %}
                                                                    <div class="sr-detail-item" style="margin-bottom: 0.25rem;">
                                                                        <strong style="color: var(--sr-text);">Priority:</strong>
                                                                        <span class="sr-badge {{ 'critical' if resource.issue_specific_data.load_priority == 'high' else 'medium' }}" style="font-size: 0.6rem; padding: 0.0625rem 0.25rem;">
                                                                            {{ resource.issue_specific_data.load_priority.title() }}
                                                                        </span>
                                                                    </div>
                                                                    {% endif %}
                                                                    {% if resource.resource_type == 'javascript' %}
                                                                        {% if resource.issue_specific_data.get('has_async') is defined or resource.issue_specific_data.get('has_defer') is defined %}
                                                                        <div class="sr-detail-item" style="margin-bottom: 0.25rem;">
                                                                            <strong style="color: var(--sr-text);">Attributes:</strong>
                                                                            {% if resource.issue_specific_data.get('has_async') %}
                                                                            <span class="sr-badge success" style="font-size: 0.6rem; padding: 0.0625rem 0.25rem; margin-right: 0.125rem;">async</span>
                                                                            {% endif %}
                                                                            {% if resource.issue_specific_data.get('has_defer') %}
                                                                            <span class="sr-badge success" style="font-size: 0.6rem; padding: 0.0625rem 0.25rem;">defer</span>
                                                                            {% endif %}
                                                                            {% if not resource.issue_specific_data.get('has_async') and not resource.issue_specific_data.get('has_defer') %}
                                                                            <span style="color: var(--sr-text-muted); font-style: italic;">None</span>
                                                                            {% endif %}
                                                                        </div>
                                                                        {% endif %}
                                                                    {% endif %}
                                                                {% endif %}
                                                                
                                                                <!-- Schema-specific details -->
                                                                {% if resource.resource_type == 'schema_markup' %}
                                                                    {% if resource.issue_specific_data.get('schema_type') %}
                                                                    <div class="sr-detail-item" style="margin-bottom: 0.25rem;">
                                                                        <strong style="color: var(--sr-text);">Schema:</strong>
                                                                        <span>{{ resource.issue_specific_data.schema_type }}</span>
                                                                    </div>
                                                                    {% endif %}
                                                                    {% if resource.issue_specific_data.get('missing_properties') %}
                                                                    <div class="sr-detail-item" style="margin-bottom: 0.25rem;">
                                                                        <strong style="color: var(--sr-text);">Missing:</strong>
                                                                        <span style="color: var(--sr-warning);">{{ resource.issue_specific_data.missing_properties|length }} prop{{ 's' if resource.issue_specific_data.missing_properties|length != 1 else '' }}</span>
                                                                    </div>
                                                                    {% endif %}
                                                                {% endif %}
                                                                
                                                                <!-- Content-specific details -->
                                                                {% if resource.resource_type == 'content_block' %}
                                                                    {% if resource.issue_specific_data.get('current_word_count') %}
                                                                    <div class="sr-detail-item" style="margin-bottom: 0.25rem;">
                                                                        <strong style="color: var(--sr-text);">Words:</strong>
                                                                        <span>{{ resource.issue_specific_data.current_word_count }}</span>
                                                                        {% if resource.issue_specific_data.get('minimum_recommended') %}
                                                                        <span style="color: var(--sr-text-muted);">/ {{ resource.issue_specific_data.minimum_recommended }}</span>
                                                                        {% endif %}
                                                                    </div>
                                                                    {% endif %}
                                                                {% endif %}
                                                                
                                                                <!-- Form-specific details -->
                                                                {% if resource.resource_type == 'form_element' %}
                                                                    {% if resource.issue_specific_data.get('input_type') %}
                                                                    <div class="sr-detail-item" style="margin-bottom: 0.25rem;">
                                                                        <strong style="color: var(--sr-text);">Input:</strong>
                                                                        <span>{{ resource.issue_specific_data.input_type }}</span>
                                                                    </div>
                                                                    {% endif %}
                                                                    {% if resource.issue_specific_data.get('accessibility_impact') %}
                                                                    <div class="sr-detail-item" style="margin-bottom: 0.25rem;">
                                                                        <strong style="color: var(--sr-text);">Impact:</strong>
                                                                        <span style="color: var(--sr-danger);">{{ resource.issue_specific_data.accessibility_impact.replace('_', ' ').title() }}</span>
                                                                    </div>
                                                                    {% endif %}
                                                                {% endif %}
                                                            </div>
                                                            {% endif %}
                                                        </td>
                                                        
                                                        <!-- Impact Column -->
                                                        <td class="sr-resource-cell" style="padding: 0.5rem; vertical-align: top; text-align: center;">
                                                            {% if resource.issue_specific_data %}
                                                            <div class="sr-impact-indicators" style="display: flex; flex-direction: column; gap: 0.25rem; align-items: center;">
                                                                {% if resource.issue_specific_data.get('estimated_delay_ms') %}
                                                                <div class="sr-impact-metric" style="display: flex; align-items: center; gap: 0.125rem;">
                                                                    <i class="bi bi-clock" style="color: var(--sr-warning); font-size: 0.7rem;"></i>
                                                                    <span style="font-size: 0.65rem; color: var(--sr-text);">{{ resource.issue_specific_data.estimated_delay_ms|round(0) }}ms</span>
                                                                </div>
                                                                {% endif %}
                                                                {% if resource.issue_specific_data.get('seo_score') is defined %}
                                                                <div class="sr-impact-metric">
                                                                    <div class="sr-mini-progress" style="width: 25px; height: 4px; background: var(--sr-gray-200); border-radius: 2px; overflow: hidden;">
                                                                        <div style="width: {{ resource.issue_specific_data.seo_score }}%; height: 100%; background: {{ 'var(--sr-success)' if resource.issue_specific_data.seo_score >= 70 else 'var(--sr-warning)' if resource.issue_specific_data.seo_score >= 40 else 'var(--sr-danger)' }};"></div>
                                                                    </div>
                                                                    <div style="font-size: 0.6rem; color: var(--sr-text-muted); margin-top: 0.125rem;">{{ resource.issue_specific_data.seo_score }}/100</div>
                                                                </div>
                                                                {% endif %}
                                                                {% if resource.resource_type == 'image' and resource.issue_specific_data.get('size_reduction_potential') %}
                                                                <div class="sr-impact-metric" style="display: flex; align-items: center; gap: 0.125rem;">
                                                                    <i class="bi bi-arrow-down-circle" style="color: var(--sr-success); font-size: 0.7rem;"></i>
                                                                    <span style="font-size: 0.65rem; color: var(--sr-text);">-{{ (resource.issue_specific_data.size_reduction_potential / 1000000)|round(1) }}MB</span>
                                                                </div>
                                                                {% endif %}
                                                                {% if not resource.issue_specific_data.get('estimated_delay_ms') and not resource.issue_specific_data.get('seo_score') and not resource.issue_specific_data.get('size_reduction_potential') %}
                                                                <i class="bi bi-dash-circle" style="color: var(--sr-text-muted); font-size: 0.875rem;" title="Impact data not available"></i>
                                                                {% endif %}
                                                            </div>
                                                            {% endif %}
                                                        </td>
                                                        
                                                        <!-- Action Column -->
                                                        <td class="sr-resource-cell" style="padding: 0.5rem; vertical-align: top; text-align: center;">
                                                            <div class="sr-action-button" style="position: relative;">
                                                                {% if resource.resource_type == 'image' %}
                                                                    {% if resource.issue_specific_data.get('current_alt') is defined %}
                                                                    <i class="bi bi-pencil-square sr-action-icon" style="color: var(--sr-primary); cursor: pointer; font-size: 0.875rem;" 
                                                                       title="Add/Edit alt text" onclick="showResourceActions('{{ loop.index }}', 'image-alt')"></i>
                                                                    {% else %}
                                                                    <i class="bi bi-image sr-action-icon" style="color: var(--sr-info); cursor: pointer; font-size: 0.875rem;" 
                                                                       title="Optimize image" onclick="showResourceActions('{{ loop.index }}', 'image-optimize')"></i>
                                                                    {% endif %}
                                                                {% elif resource.resource_type in ['css', 'javascript'] %}
                                                                <i class="bi bi-code-square sr-action-icon" style="color: var(--sr-warning); cursor: pointer; font-size: 0.875rem;" 
                                                                   title="Optimize loading" onclick="showResourceActions('{{ loop.index }}', 'script-optimize')"></i>
                                                                {% elif resource.resource_type == 'schema_markup' %}
                                                                <i class="bi bi-plus-square sr-action-icon" style="color: var(--sr-success); cursor: pointer; font-size: 0.875rem;" 
                                                                   title="Add schema markup" onclick="showResourceActions('{{ loop.index }}', 'schema-add')"></i>
                                                                {% elif resource.resource_type == 'form_element' %}
                                                                <i class="bi bi-ui-checks sr-action-icon" style="color: var(--sr-secondary); cursor: pointer; font-size: 0.875rem;" 
                                                                   title="Fix accessibility" onclick="showResourceActions('{{ loop.index }}', 'form-fix')"></i>
                                                                {% else %}
                                                                <i class="bi bi-tools sr-action-icon" style="color: var(--sr-info); cursor: pointer; font-size: 0.875rem;" 
                                                                   title="Fix issue" onclick="showResourceActions('{{ loop.index }}', 'generic-fix')"></i>
                                                                {% endif %}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        {% else %}
                                        <!-- Fallback to original pages list if no resource details -->
                                        <div style="font-size: 0.875rem; font-weight: 500; color: var(--sr-text); margin-bottom: 0.5rem;">
                                            Pagine Interessate:
                                        </div>
                                        <div style="max-height: 200px; overflow-y: auto;">
                                            {% for page_url in issue_data.pages %}
                                            <div style="padding: 0.25rem 0; border-bottom: 1px solid var(--sr-border-light); last-child:border-bottom: none;">
                                                <a href="{{ page_url }}" target="_blank" class="sr-url" 
                                                   style="font-size: 0.85rem; display: block; padding: 0.25rem 0.5rem; border-radius: 3px; text-decoration: none;"
                                                   onmouseover="this.style.background='var(--sr-gray-50)'" 
                                                   onmouseout="this.style.background='transparent'">
                                                    <i class="bi bi-link-45deg" style="color: var(--sr-text-muted); margin-right: 0.25rem;"></i>
                                                    {{ page_url }}
                                                </a>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                <div class="sr-empty-state">
                    <div class="sr-empty-icon">
                        <i class="bi bi-check-circle-fill sr-text-success"></i>
                    </div>
                    <h3 class="sr-empty-title">Nessun Problema Rilevato</h3>
                    <p class="sr-empty-description">
                        Eccellente! Il sito non presenta problemi SEO significativi.
                    </p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Core Web Vitals Section -->
        {% if performance_overview and performance_overview.avg_performance_score > 0 %}
        <div class="sr-section sr-fade-in">
            <div class="sr-section-header">
                <h2 class="sr-section-title">
                    <i class="bi bi-speedometer2"></i>
                    Core Web Vitals & Performance
                </h2>
                <p class="sr-section-subtitle">
                    Analisi delle performance e dei Core Web Vitals per {{ performance_overview.pages_with_performance_data }} pagine
                </p>
            </div>
            
            <div class="sr-section-body">
                <!-- Performance Overview Cards -->
                <div class="row mb-4">
                    <div class="col-md-3 col-6 mb-3">
                        <div class="sr-performance-metric">
                            <div class="sr-metric-icon">
                                <i class="bi bi-speedometer2"></i>
                            </div>
                            <div class="sr-metric-value">{{ performance_overview.avg_performance_score }}/100</div>
                            <div class="sr-metric-label">Performance Media</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="sr-performance-metric">
                            <div class="sr-metric-icon">
                                <i class="bi bi-gear"></i>
                            </div>
                            <div class="sr-metric-value">{{ performance_overview.avg_technical_score }}/100</div>
                            <div class="sr-metric-label">SEO Tecnico Medio</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="sr-performance-metric">
                            <div class="sr-metric-icon">
                                <i class="bi bi-phone"></i>
                            </div>
                            <div class="sr-metric-value">{{ performance_overview.mobile_coverage }}%</div>
                            <div class="sr-metric-label">Mobile Optimization</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="sr-performance-metric">
                            <div class="sr-metric-icon">
                                <i class="bi bi-code-square"></i>
                            </div>
                            <div class="sr-metric-value">{{ performance_overview.schema_coverage }}%</div>
                            <div class="sr-metric-label">Schema Markup</div>
                        </div>
                    </div>
                </div>
                
                <!-- Sample Core Web Vitals data from first page -->
                {% set sample_page = pages[0] if pages else None %}
                {% if sample_page and sample_page.core_web_vitals %}
                    {% set cwv_data = sample_page.core_web_vitals %}
                    {% set scores = cwv_data.get('scores', {}) %}
                    
                    <!-- Display sample Core Web Vitals -->
                    <div class="row">
                        {% if scores.get('lcp') %}
                        <div class="col-md-2 col-6 mb-3">
                            <div class="sr-cwv-mini {{ 'good' if scores.lcp.rating == 'good' else 'needs-improvement' if scores.lcp.rating == 'needs_improvement' else 'poor' }}">
                                <div class="sr-cwv-acronym">LCP</div>
                                <div class="sr-cwv-value">{{ scores.lcp.value|round(2) }}s</div>
                                <div class="sr-cwv-rating">{{ scores.lcp.rating.replace('_', ' ').title() }}</div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if scores.get('fid') %}
                        <div class="col-md-2 col-6 mb-3">
                            <div class="sr-cwv-mini {{ 'good' if scores.fid.rating == 'good' else 'needs-improvement' if scores.fid.rating == 'needs_improvement' else 'poor' }}">
                                <div class="sr-cwv-acronym">FID</div>
                                <div class="sr-cwv-value">{{ scores.fid.value|round(0) }}ms</div>
                                <div class="sr-cwv-rating">{{ scores.fid.rating.replace('_', ' ').title() }}</div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if scores.get('cls') %}
                        <div class="col-md-2 col-6 mb-3">
                            <div class="sr-cwv-mini {{ 'good' if scores.cls.rating == 'good' else 'needs-improvement' if scores.cls.rating == 'needs_improvement' else 'poor' }}">
                                <div class="sr-cwv-acronym">CLS</div>
                                <div class="sr-cwv-value">{{ scores.cls.value|round(3) }}</div>
                                <div class="sr-cwv-rating">{{ scores.cls.rating.replace('_', ' ').title() }}</div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if scores.get('fcp') %}
                        <div class="col-md-2 col-6 mb-3">
                            <div class="sr-cwv-mini {{ 'good' if scores.fcp.rating == 'good' else 'needs-improvement' if scores.fcp.rating == 'needs_improvement' else 'poor' }}">
                                <div class="sr-cwv-acronym">FCP</div>
                                <div class="sr-cwv-value">{{ scores.fcp.value|round(2) }}s</div>
                                <div class="sr-cwv-rating">{{ scores.fcp.rating.replace('_', ' ').title() }}</div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if scores.get('ttfb') %}
                        <div class="col-md-2 col-6 mb-3">
                            <div class="sr-cwv-mini {{ 'good' if scores.ttfb.rating == 'good' else 'needs-improvement' if scores.ttfb.rating == 'needs_improvement' else 'poor' }}">
                                <div class="sr-cwv-acronym">TTFB</div>
                                <div class="sr-cwv-value">{{ scores.ttfb.value|round(0) }}ms</div>
                                <div class="sr-cwv-rating">{{ scores.ttfb.rating.replace('_', ' ').title() }}</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Technical SEO Overview Section -->
        {% if performance_overview and performance_overview.avg_technical_score > 0 %}
        <div class="sr-section sr-fade-in">
            <div class="sr-section-header">
                <h2 class="sr-section-title">
                    <i class="bi bi-gear-fill"></i>
                    Technical SEO Overview
                </h2>
                <p class="sr-section-subtitle">
                    Analisi tecnica SEO per {{ performance_overview.pages_with_technical_data }} pagine
                </p>
            </div>
            
            <div class="sr-section-body">
                <!-- Technical Overview Grid -->
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="sr-tech-overview-card">
                            <h4><i class="bi bi-code-square"></i> Schema Markup</h4>
                            <div class="sr-tech-stats">
                                <div class="sr-stat-item">
                                    <span class="sr-stat-value">{{ performance_overview.schema_coverage }}%</span>
                                    <span class="sr-stat-label">Pagine con Schema</span>
                                </div>
                                {% set total_schema_pages = (performance_overview.schema_coverage / 100 * performance_overview.total_pages_analyzed)|round %}
                                <div class="sr-stat-item">
                                    <span class="sr-stat-value">{{ total_schema_pages|int }}/{{ performance_overview.total_pages_analyzed }}</span>
                                    <span class="sr-stat-label">Pagine Implementate</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                        <div class="sr-tech-overview-card">
                            <h4><i class="bi bi-phone"></i> Mobile Optimization</h4>
                            <div class="sr-tech-stats">
                                <div class="sr-stat-item">
                                    <span class="sr-stat-value">{{ performance_overview.mobile_coverage }}%</span>
                                    <span class="sr-stat-label">Pagine Ottimizzate</span>
                                </div>
                                {% set total_mobile_pages = (performance_overview.mobile_coverage / 100 * performance_overview.total_pages_analyzed)|round %}
                                <div class="sr-stat-item">
                                    <span class="sr-stat-value">{{ total_mobile_pages|int }}/{{ performance_overview.total_pages_analyzed }}</span>
                                    <span class="sr-stat-label">Mobile Ready</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sample Technical SEO data -->
                {% set sample_page = pages[0] if pages else None %}
                {% if sample_page and sample_page.technical_seo_data %}
                    {% set tech_data = sample_page.technical_seo_data %}
                    {% set schema_data = tech_data.get('schema_markup', {}) %}
                    {% set social_data = tech_data.get('social_meta_tags', {}) %}
                    
                    <div class="sr-tech-sample">
                        <h5><i class="bi bi-eye"></i> Esempio Analisi Tecnica (Prima Pagina)</h5>
                        <div class="row">
                            {% if schema_data.get('schema_types') %}
                            <div class="col-md-4 mb-3">
                                <div class="sr-tech-detail">
                                    <strong>Schema Types Found:</strong>
                                    <div class="sr-schema-tags">
                                        {% for schema_type in schema_data.schema_types[:3] %}
                                        <span class="sr-schema-tag">{{ schema_type }}</span>
                                        {% endfor %}
                                        {% if schema_data.schema_types|length > 3 %}
                                        <span class="sr-schema-tag">+{{ schema_data.schema_types|length - 3 }} more</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if social_data.get('overall_coverage') %}
                            <div class="col-md-4 mb-3">
                                <div class="sr-tech-detail">
                                    <strong>Social Meta Coverage:</strong>
                                    <div class="sr-coverage-bar">
                                        <div class="sr-coverage-fill" style="width: {{ social_data.overall_coverage }}%"></div>
                                        <span class="sr-coverage-text">{{ social_data.overall_coverage|round(1) }}%</span>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if sample_page.mobile_score %}
                            <div class="col-md-4 mb-3">
                                <div class="sr-tech-detail">
                                    <strong>Mobile Score:</strong>
                                    <div class="sr-mobile-score {{ 'good' if sample_page.mobile_score >= 70 else 'needs-improvement' if sample_page.mobile_score >= 40 else 'poor' }}">
                                        {{ sample_page.mobile_score|round(1) }}/100
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Pages Performance Section -->
        <div class="sr-section sr-fade-in">
            <div class="sr-section-header">
                <h2 class="sr-section-title">
                    <i class="bi bi-speedometer2"></i>
                    Performance delle Pagine
                </h2>
                <p class="sr-section-subtitle">
                    {% if pagination %}
                    Mostrando pagine {{ pagination.start_item }}-{{ pagination.end_item }} di {{ pagination.total_items }} totali
                    (Pagina {{ pagination.current_page }} di {{ pagination.total_pages }})
                    {% else %}
                    Analisi dettagliata delle {{ pages|length }} pagine scansionate con score SEO e problemi per pagina
                    {% endif %}
                </p>
            </div>
            
            <div class="sr-section-body">
                {% if pages %}
                <div class="table-responsive">
                    <table class="sr-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">URL</th>
                                <th style="width: 25%;">Titolo Pagina</th>
                                <th style="width: 10%;">Status</th>
                                <th style="width: 15%;">Score SEO</th>
                                <th style="width: 10%;">Problemi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for page in pages|sort(attribute='seo_score', reverse=true) %}
                            <tr>
                                <td>
                                    <a href="{{ page.url }}" target="_blank" class="sr-url" title="{{ page.url }}">
                                        {{ page.url }}
                                    </a>
                                </td>
                                <td>
                                    <div class="sr-truncate" style="max-width: 200px;" title="{{ page.title or 'Nessun titolo' }}">
                                        {{ page.title or 'Nessun titolo' }}
                                    </div>
                                </td>
                                <td>
                                    <span class="sr-badge status-{{ page.status_code if page.status_code else '000' }}">
                                        {{ page.status_code or '000' }}
                                    </span>
                                </td>
                                <td>
                                    {% if page.seo_score %}
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <div class="sr-progress" style="width: 50px;">
                                            <div class="sr-progress-bar {{ 'excellent' if page.seo_score >= 80 else 'good' if page.seo_score >= 60 else 'fair' if page.seo_score >= 40 else 'poor' }}" 
                                                 style="width: {{ page.seo_score }}%;"></div>
                                        </div>
                                        <span style="font-weight: 500; min-width: 35px;">{{ page.seo_score }}</span>
                                    </div>
                                    {% else %}
                                    <span class="sr-text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if page.issues_count > 0 %}
                                    <span class="sr-badge {{ 'critical' if page.issues_count >= 10 else 'high' if page.issues_count >= 5 else 'medium' }}">
                                        {{ page.issues_count }}
                                    </span>
                                    {% else %}
                                    <span class="sr-badge low">
                                        <i class="bi bi-check"></i> 0
                                    </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Controls -->
                {% if pagination and pagination.total_pages > 1 %}
                <div style="padding: 1.5rem; border-top: 1px solid var(--sr-border); background: var(--sr-gray-50);">
                    <div style="display: flex; justify-content: between; align-items: center; gap: 1rem;">
                        <!-- Left: Items info -->
                        <div style="font-size: 0.875rem; color: var(--sr-text-muted);">
                            Mostrando {{ pagination.start_item }}-{{ pagination.end_item }} di {{ pagination.total_items }}
                        </div>
                        
                        <!-- Center: Page controls -->
                        <div style="display: flex; gap: 0.5rem; align-items: center; margin-left: auto;">
                            <!-- Previous button -->
                            {% if pagination.has_prev %}
                            <a href="/templated/scan/{{ scan.id }}/results?page={{ pagination.prev_page }}" 
                               class="sr-btn sr-btn-outline" style="padding: 0.5rem 0.75rem;">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                            {% else %}
                            <span class="sr-btn sr-btn-outline" style="padding: 0.5rem 0.75rem; opacity: 0.5; cursor: not-allowed;">
                                <i class="bi bi-chevron-left"></i>
                            </span>
                            {% endif %}
                            
                            <!-- Page numbers -->
                            {% set start_page = (pagination.current_page - 2) if pagination.current_page > 2 else 1 %}
                            {% set end_page = (pagination.current_page + 2) if (pagination.current_page + 2) <= pagination.total_pages else pagination.total_pages %}
                            
                            {% if start_page > 1 %}
                            <a href="/templated/scan/{{ scan.id }}/results?page=1" 
                               class="sr-btn sr-btn-outline" style="padding: 0.5rem 0.75rem; min-width: 40px;">1</a>
                            {% if start_page > 2 %}
                            <span style="padding: 0.5rem; color: var(--sr-text-muted);">...</span>
                            {% endif %}
                            {% endif %}
                            
                            {% for page_num in range(start_page, end_page + 1) %}
                            {% if page_num == pagination.current_page %}
                            <span class="sr-btn sr-btn-primary" style="padding: 0.5rem 0.75rem; min-width: 40px;">{{ page_num }}</span>
                            {% else %}
                            <a href="/templated/scan/{{ scan.id }}/results?page={{ page_num }}" 
                               class="sr-btn sr-btn-outline" style="padding: 0.5rem 0.75rem; min-width: 40px;">{{ page_num }}</a>
                            {% endif %}
                            {% endfor %}
                            
                            {% if end_page < pagination.total_pages %}
                            {% if end_page < pagination.total_pages - 1 %}
                            <span style="padding: 0.5rem; color: var(--sr-text-muted);">...</span>
                            {% endif %}
                            <a href="/templated/scan/{{ scan.id }}/results?page={{ pagination.total_pages }}" 
                               class="sr-btn sr-btn-outline" style="padding: 0.5rem 0.75rem; min-width: 40px;">{{ pagination.total_pages }}</a>
                            {% endif %}
                            
                            <!-- Next button -->
                            {% if pagination.has_next %}
                            <a href="/templated/scan/{{ scan.id }}/results?page={{ pagination.next_page }}" 
                               class="sr-btn sr-btn-outline" style="padding: 0.5rem 0.75rem;">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                            {% else %}
                            <span class="sr-btn sr-btn-outline" style="padding: 0.5rem 0.75rem; opacity: 0.5; cursor: not-allowed;">
                                <i class="bi bi-chevron-right"></i>
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- Right: Per page selector -->
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 0.875rem; color: var(--sr-text-muted);">Per pagina:</span>
                            <select onchange="changePagination(this.value)" style="padding: 0.25rem 0.5rem; border: 1px solid var(--sr-border); border-radius: 4px; font-size: 0.875rem;">
                                <option value="25" {% if pagination.per_page == 25 %}selected{% endif %}>25</option>
                                <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50</option>
                                <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100</option>
                                <option value="200" {% if pagination.per_page == 200 %}selected{% endif %}>200</option>
                            </select>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% else %}
                <div class="sr-empty-state">
                    <div class="sr-empty-icon">
                        <i class="bi bi-file-earmark-x"></i>
                    </div>
                    <h3 class="sr-empty-title">Nessuna Pagina Scansionata</h3>
                    <p class="sr-empty-description">
                        La scansione potrebbe essere ancora in corso o non è riuscita a trovare pagine.
                    </p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Smart Issue Prioritization Matrix -->
        {% if priority_data and priority_data.summary.total_issues > 0 %}
        <div class="sr-section sr-fade-in">
            {% include 'components/priority_matrix.html' %}
        </div>
        {% endif %}

        <!-- Quick Actions & Summary -->
        <div class="sr-section sr-fade-in">
            <div class="sr-section-header">
                <h2 class="sr-section-title">
                    <i class="bi bi-lightning"></i>
                    Prossimi Passi Consigliati
                </h2>
                <p class="sr-section-subtitle">
                    Azioni prioritarie basate sui risultati della scansione
                </p>
            </div>
            
            <div class="sr-section-body" style="padding: 1.5rem;">
                {% set critical_count = issues|selectattr('severity', 'equalto', 'critical')|list|length %}
                {% set high_count = issues|selectattr('severity', 'equalto', 'high')|list|length %}
                
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h4 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: var(--sr-text);">
                            <i class="bi bi-star"></i> Priorità Alta
                        </h4>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            {% if critical_count > 0 %}
                            <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--sr-border);">
                                <i class="bi bi-exclamation-triangle" style="color: var(--sr-danger); margin-right: 0.5rem;"></i>
                                Risolvere {{ critical_count }} problema{{ 's' if critical_count != 1 else '' }} critico{{ 's' if critical_count != 1 else '' }}
                            </li>
                            {% endif %}
                            {% if high_count > 0 %}
                            <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--sr-border);">
                                <i class="bi bi-exclamation-circle" style="color: var(--sr-warning); margin-right: 0.5rem;"></i>
                                Gestire {{ high_count }} problema{{ 's' if high_count != 1 else '' }} ad alta priorità
                            </li>
                            {% endif %}
                            {% if not critical_count and not high_count %}
                            <li style="padding: 0.5rem 0;">
                                <i class="bi bi-check-circle" style="color: var(--sr-success); margin-right: 0.5rem;"></i>
                                Nessun problema critico o ad alta priorità
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                        <h4 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: var(--sr-text);">
                            <i class="bi bi-graph-up"></i> Ottimizzazioni
                        </h4>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            {% set low_score_pages = pages|selectattr('seo_score')|selectattr('seo_score', 'lt', 60)|list|length %}
                            {% if low_score_pages > 0 %}
                            <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--sr-border);">
                                <i class="bi bi-speedometer" style="color: var(--sr-info); margin-right: 0.5rem;"></i>
                                Migliorare {{ low_score_pages }} pagina{{ 's' if low_score_pages != 1 else '' }} con score basso
                            </li>
                            {% endif %}
                            <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--sr-border);">
                                <i class="bi bi-download" style="color: var(--sr-primary); margin-right: 0.5rem;"></i>
                                Scaricare il report PDF completo
                            </li>
                            <li style="padding: 0.5rem 0;">
                                <i class="bi bi-arrow-repeat" style="color: var(--sr-info); margin-right: 0.5rem;"></i>
                                Programmare scansione di follow-up
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--sr-border); text-align: center;">
                    <a href="/api/v1/scans/{{ scan.id }}/report" class="sr-btn sr-btn-primary" target="_blank" style="margin-right: 1rem;">
                        <i class="bi bi-download"></i>
                        Scarica Report Completo
                    </a>
                    <a href="/templated/scans" class="sr-btn sr-btn-outline">
                        <i class="bi bi-plus-circle"></i>
                        Avvia Nuova Scansione
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Error State -->
    <div class="container-fluid">
        <div class="sr-section">
            <div class="sr-empty-state">
                <div class="sr-empty-icon">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <h3 class="sr-empty-title">Scansione Non Trovata</h3>
                <p class="sr-empty-description">
                    La scansione richiesta non esiste o non è più accessibile.
                </p>
                <div style="margin-top: 2rem;">
                    <a href="/templated/scans" class="sr-btn sr-btn-primary">
                        <i class="bi bi-arrow-left"></i>
                        Torna alle Scansioni
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>


<script>
// Enhanced JavaScript for SEMrush-style accordion and tabs
document.addEventListener('DOMContentLoaded', function() {
    // Add fade-in animation delays
    const elements = document.querySelectorAll('.sr-fade-in');
    elements.forEach((el, index) => {
        el.style.animationDelay = `${index * 0.1}s`;
    });
    
    // Add hover effects for metric cards
    const metricCards = document.querySelectorAll('.sr-metric-card');
    metricCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-4px)';
            this.style.boxShadow = 'var(--sr-shadow-lg)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '';
        });
    });
    
    // Smooth scroll for internal links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});

// Removed tab switching functionality - now using single severity view only

// Accordion functionality
function toggleAccordion(accordionId) {
    const content = document.getElementById('content-' + accordionId);
    const icon = document.getElementById('icon-' + accordionId);
    
    if (content.style.display === 'none' || content.style.display === '') {
        // Open accordion
        content.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
        
        // Add smooth opening animation
        content.style.opacity = '0';
        content.style.maxHeight = '0';
        content.style.overflow = 'hidden';
        content.style.transition = 'all 0.3s ease-in-out';
        
        setTimeout(() => {
            content.style.opacity = '1';
            content.style.maxHeight = 'none';
        }, 10);
    } else {
        // Close accordion
        content.style.maxHeight = content.scrollHeight + 'px';
        content.style.transition = 'all 0.3s ease-in-out';
        
        setTimeout(() => {
            content.style.opacity = '0';
            content.style.maxHeight = '0';
        }, 10);
        
        setTimeout(() => {
            content.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }, 300);
    }
}

// Nested accordion functionality for double accordion (Level 2)
function toggleNestedAccordion(nestedId) {
    const content = document.getElementById('content-nested-' + nestedId);
    const icon = document.getElementById('icon-nested-' + nestedId);
    
    if (!content || !icon) {
        console.warn('Nested accordion elements not found for ID:', nestedId);
        return;
    }
    
    if (content.style.display === 'none' || content.style.display === '') {
        // Open nested accordion
        content.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
        
        // Add smooth opening animation
        content.style.opacity = '0';
        content.style.maxHeight = '0';
        content.style.overflow = 'hidden';
        content.style.transition = 'all 0.3s ease-in-out';
        
        setTimeout(() => {
            content.style.opacity = '1';
            content.style.maxHeight = 'none';
        }, 10);
    } else {
        // Close nested accordion
        content.style.maxHeight = content.scrollHeight + 'px';
        content.style.transition = 'all 0.3s ease-in-out';
        
        setTimeout(() => {
            content.style.opacity = '0';
            content.style.maxHeight = '0';
        }, 10);
        
        setTimeout(() => {
            content.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }, 300);
    }
}

// Auto-expand critical issues on load
document.addEventListener('DOMContentLoaded', function() {
    // Auto-expand critical issues if they exist
    const criticalContent = document.getElementById('content-severity-critical');
    if (criticalContent) {
        setTimeout(() => {
            toggleAccordion('severity-critical');
        }, 500);
    }
});

// Pagination functionality
function changePagination(perPage) {
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.set('per_page', perPage);
    currentUrl.searchParams.set('page', '1'); // Reset to first page
    window.location.href = currentUrl.toString();
}

// Enhanced Resource Table Functionality
function sortResourceTable(selectElement, tableId) {
    const sortBy = selectElement.value;
    const table = document.getElementById('resource-table-' + tableId);
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Store original order for reference
    if (!tbody.hasAttribute('data-original-order')) {
        tbody.setAttribute('data-original-order', 'true');
    }
    
    rows.sort((a, b) => {
        let aValue, bValue;
        
        switch(sortBy) {
            case 'page':
                aValue = a.cells[0].getAttribute('data-sort-key') || '';
                bValue = b.cells[0].getAttribute('data-sort-key') || '';
                break;
            case 'resource':
                aValue = a.cells[1].getAttribute('data-sort-key') || '';
                bValue = b.cells[1].getAttribute('data-sort-key') || '';
                break;
            case 'type':
                aValue = a.cells[2].getAttribute('data-sort-key') || '';
                bValue = b.cells[2].getAttribute('data-sort-key') || '';
                break;
            case 'impact':
                // Sort by estimated delay or SEO score impact
                const aImpact = extractImpactValue(a.cells[4]);
                const bImpact = extractImpactValue(b.cells[4]);
                return bImpact - aImpact; // Descending order for impact
            default:
                return 0;
        }
        
        return aValue.localeCompare(bValue);
    });
    
    // Clear and re-append sorted rows
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
    
    // Add visual feedback
    addSortingFeedback(table, sortBy);
}

function extractImpactValue(cell) {
    // Extract numeric impact value from the cell for sorting
    const delayElement = cell.querySelector('[title*="ms"]');
    const scoreElement = cell.querySelector('.sr-mini-progress');
    
    if (delayElement) {
        const delayText = delayElement.textContent.match(/(\d+)ms/);
        return delayText ? parseInt(delayText[1]) : 0;
    }
    
    if (scoreElement) {
        const scoreBar = scoreElement.querySelector('div[style*="width"]');
        if (scoreBar) {
            const widthMatch = scoreBar.style.width.match(/(\d+)%/);
            return widthMatch ? parseInt(widthMatch[1]) : 0;
        }
    }
    
    return 0;
}

function addSortingFeedback(table, sortBy) {
    // Remove existing sort indicators
    table.querySelectorAll('.sr-sort-indicator').forEach(el => el.remove());
    
    // Add sort indicator to appropriate column header
    const columnMap = {
        'page': 0,
        'resource': 1,
        'type': 2,
        'impact': 4
    };
    
    const columnIndex = columnMap[sortBy];
    if (columnIndex !== undefined) {
        const header = table.querySelector(`th:nth-child(${columnIndex + 1}) .sr-th-content`);
        if (header) {
            const indicator = document.createElement('i');
            indicator.className = 'bi bi-arrow-down sr-sort-indicator';
            indicator.style.marginLeft = '0.25rem';
            indicator.style.color = 'var(--sr-primary)';
            indicator.style.fontSize = '0.7rem';
            header.appendChild(indicator);
        }
    }
}

// Resource Action Handlers
function showResourceActions(resourceIndex, actionType) {
    // Create a tooltip/modal for resource-specific actions
    const tooltip = createActionTooltip(actionType);
    
    // Position tooltip near the clicked action button
    const actionButton = event.target.closest('.sr-action-button');
    if (actionButton) {
        positionTooltip(tooltip, actionButton);
        document.body.appendChild(tooltip);
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
            if (tooltip.parentNode) {
                tooltip.remove();
            }
        }, 3000);
    }
}

function createActionTooltip(actionType) {
    const tooltip = document.createElement('div');
    tooltip.className = 'sr-action-tooltip';
    tooltip.style.cssText = `
        position: absolute;
        background: var(--sr-gray-800);
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        z-index: 1000;
        box-shadow: var(--sr-shadow-lg);
        max-width: 200px;
        line-height: 1.3;
        pointer-events: none;
    `;
    
    const actionMessages = {
        'image-alt': 'Suggestion: Add descriptive alt text for better accessibility and SEO',
        'image-optimize': 'Suggestion: Optimize image size and compression for faster loading',
        'script-optimize': 'Suggestion: Add async/defer attributes or move to end of body',
        'schema-add': 'Suggestion: Implement structured data markup for rich snippets',
        'form-fix': 'Suggestion: Add proper labels for accessibility compliance',
        'generic-fix': 'Review this resource for optimization opportunities'
    };
    
    tooltip.textContent = actionMessages[actionType] || actionMessages['generic-fix'];
    
    // Add arrow pointer
    const arrow = document.createElement('div');
    arrow.style.cssText = `
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-top: 6px solid var(--sr-gray-800);
    `;
    tooltip.appendChild(arrow);
    
    return tooltip;
}

function positionTooltip(tooltip, targetElement) {
    const rect = targetElement.getBoundingClientRect();
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
    
    tooltip.style.left = (rect.left + scrollLeft + rect.width / 2) + 'px';
    tooltip.style.top = (rect.top + scrollTop - 10) + 'px';
    tooltip.style.transform = 'translateX(-50%) translateY(-100%)';
}

// Enhanced accordion functionality for resource details
function toggleResourceDetails(resourceId) {
    const detailsRow = document.getElementById('resource-details-' + resourceId);
    const toggleIcon = document.getElementById('resource-toggle-' + resourceId);
    
    if (detailsRow) {
        if (detailsRow.style.display === 'none' || !detailsRow.style.display) {
            // Show details
            detailsRow.style.display = 'table-row';
            detailsRow.style.opacity = '0';
            detailsRow.style.transition = 'opacity 0.3s ease';
            
            setTimeout(() => {
                detailsRow.style.opacity = '1';
            }, 10);
            
            if (toggleIcon) {
                toggleIcon.style.transform = 'rotate(180deg)';
            }
        } else {
            // Hide details
            detailsRow.style.opacity = '0';
            
            setTimeout(() => {
                detailsRow.style.display = 'none';
                if (toggleIcon) {
                    toggleIcon.style.transform = 'rotate(0deg)';
                }
            }, 300);
        }
    }
}

// Resource filtering functionality
function filterResourcesByType(tableId, resourceType) {
    const table = document.getElementById('resource-table-' + tableId);
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const rowType = row.getAttribute('data-resource-type');
        if (resourceType === 'all' || rowType === resourceType) {
            row.style.display = 'table-row';
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update filter button states
    updateFilterButtonStates(tableId, resourceType);
}

function updateFilterButtonStates(tableId, activeType) {
    const filterContainer = document.querySelector(`[data-table-id="${tableId}"] .sr-resource-filters`);
    if (filterContainer) {
        const buttons = filterContainer.querySelectorAll('.sr-filter-btn');
        buttons.forEach(btn => {
            if (btn.getAttribute('data-type') === activeType) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }
}

// Initialize resource table enhancements on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add hover effects for resource table rows
    const resourceTables = document.querySelectorAll('.sr-resource-table');
    resourceTables.forEach(table => {
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach((row, index) => {
            // Add row indexing for better identification
            row.setAttribute('data-row-index', index);
            
            // Enhanced hover effects
            row.addEventListener('mouseenter', function() {
                this.style.transform = 'translateX(2px)';
                this.style.transition = 'transform 0.2s ease';
            });
            
            row.addEventListener('mouseleave', function() {
                this.style.transform = 'translateX(0)';
            });
        });
    });
    
    // Add keyboard navigation for accessibility
    addResourceTableKeyboardNavigation();
    
    // Initialize table sorting states
    initializeTableSortingStates();
});

function addResourceTableKeyboardNavigation() {
    const resourceTables = document.querySelectorAll('.sr-resource-table');
    resourceTables.forEach(table => {
        table.setAttribute('tabindex', '0');
        table.addEventListener('keydown', function(e) {
            const focusedRow = this.querySelector('tbody tr:focus');
            if (!focusedRow) return;
            
            switch(e.key) {
                case 'ArrowUp':
                    e.preventDefault();
                    const prevRow = focusedRow.previousElementSibling;
                    if (prevRow) prevRow.focus();
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    const nextRow = focusedRow.nextElementSibling;
                    if (nextRow) nextRow.focus();
                    break;
                case 'Enter':
                case ' ':
                    e.preventDefault();
                    const actionButton = focusedRow.querySelector('.sr-action-button');
                    if (actionButton) actionButton.click();
                    break;
            }
        });
    });
}

function initializeTableSortingStates() {
    // Set default sorting to 'page' for all resource tables
    const sortSelects = document.querySelectorAll('.sr-sort-select');
    sortSelects.forEach(select => {
        select.value = 'page';
    });
}

// Utility function for responsive table handling
function handleResourceTableResize() {
    const tables = document.querySelectorAll('.sr-resource-table-container');
    tables.forEach(container => {
        const table = container.querySelector('.sr-resource-table');
        if (window.innerWidth <= 768) {
            // Mobile optimizations
            table.classList.add('sr-table-mobile');
        } else {
            table.classList.remove('sr-table-mobile');
        }
    });
}

// Listen for window resize events
window.addEventListener('resize', handleResourceTableResize);

// Performance monitoring for large tables
function monitorTablePerformance() {
    const tables = document.querySelectorAll('.sr-resource-table tbody');
    tables.forEach(tbody => {
        const rowCount = tbody.children.length;
        if (rowCount > 50) {
            // Enable virtual scrolling or pagination for large datasets
            console.log(`Large resource table detected: ${rowCount} rows`);
            // Implement virtual scrolling if needed
        }
    });
}
</script>