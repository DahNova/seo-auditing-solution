<!-- SEO Scan Results - SEMrush-Inspired Professional Design -->
<div class="sr-scan-results">
    {% if scan %}
    
    <!-- Header Section -->
    <div class="container-fluid">
        <div class="sr-header sr-fade-in">
            <div class="sr-header-top">
                <div class="sr-header-content">
                    <h1>Analisi SEO: {{ scan.website_name }}</h1>
                    <p class="sr-header-subtitle">
                        Cliente: <strong>{{ scan.client_name }}</strong> • 
                        Scansione #{{ scan.id }} • 
                        {% if scan.completed_at %}
                        Completata il {{ scan.completed_at.strftime('%d/%m/%Y alle %H:%M') }}
                        {% else %}
                        In corso...
                        {% endif %}
                    </p>
                    <div class="sr-header-meta">
                        <div class="sr-meta-item">
                            <i class="bi bi-{{ 'check-circle' if scan.status == 'completed' else 'clock' if scan.status == 'running' else 'x-circle' }} sr-meta-icon"></i>
                            <span>Status: <strong>{{ scan.status.title() }}</strong></span>
                        </div>
                        <div class="sr-meta-item">
                            <i class="bi bi-calendar3 sr-meta-icon"></i>
                            <span>Avviata: {{ scan.created_at.strftime('%d/%m/%Y %H:%M') if scan.created_at else 'N/A' }}</span>
                        </div>
                        <div class="sr-meta-item">
                            <i class="bi bi-stopwatch sr-meta-icon"></i>
                            <span>
                                {% if scan.completed_at and scan.created_at %}
                                Durata: {{ ((scan.completed_at - scan.created_at).total_seconds() / 60) | round(1) }} min
                                {% else %}
                                In corso...
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="sr-header-actions">
                    <a href="/api/v1/scans/{{ scan.id }}/report" class="sr-btn sr-btn-primary" target="_blank">
                        <i class="bi bi-download"></i>
                        Scarica Report PDF
                    </a>
                    <a href="/templated/scans" class="sr-btn sr-btn-outline">
                        <i class="bi bi-arrow-left"></i>
                        Torna alle Scansioni
                    </a>
                </div>
            </div>
        </div>

        <!-- Key Metrics Dashboard -->
        <div class="sr-metrics sr-fade-in">
            <!-- Pages Scanned -->
            <div class="sr-metric-card">
                <div class="sr-metric-header">
                    <div class="sr-metric-icon pages">
                        <i class="bi bi-files"></i>
                    </div>
                    {% if scan.seo_score %}
                    <div class="sr-score-display">
                        <div class="sr-score-circle {{ 'excellent' if scan.seo_score >= 80 else 'good' if scan.seo_score >= 60 else 'fair' if scan.seo_score >= 40 else 'poor' }}">
                            {{ scan.seo_score }}
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="sr-metric-value">{{ pages|length }}</div>
                <div class="sr-metric-label">Pagine Scansionate</div>
                {% if scan.pages_scanned and scan.pages_scanned != pages|length %}
                <div class="sr-metric-trend">{{ scan.pages_scanned }} trovate totali</div>
                {% endif %}
            </div>

            <!-- Total Issues -->
            <div class="sr-metric-card">
                <div class="sr-metric-header">
                    <div class="sr-metric-icon issues">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                </div>
                <div class="sr-metric-value">{{ issues|length }}</div>
                <div class="sr-metric-label">Problemi Totali</div>
                {% set issues_per_page = (issues|length / (pages|length if pages|length > 0 else 1)) | round(1) %}
                <div class="sr-metric-trend">{{ issues_per_page }} problemi/pagina</div>
            </div>

            <!-- Critical Issues -->
            <div class="sr-metric-card">
                <div class="sr-metric-header">
                    <div class="sr-metric-icon critical">
                        <i class="bi bi-shield-exclamation"></i>
                    </div>
                </div>
                {% set critical_issues = issues|selectattr('severity', 'equalto', 'critical')|list|length %}
                <div class="sr-metric-value">{{ critical_issues }}</div>
                <div class="sr-metric-label">Problemi Critici</div>
                {% if critical_issues > 0 %}
                <div class="sr-metric-trend sr-text-danger">Richiede attenzione immediata</div>
                {% else %}
                <div class="sr-metric-trend sr-text-success">Nessun problema critico</div>
                {% endif %}
            </div>

            <!-- Performance Score -->
            <div class="sr-metric-card">
                <div class="sr-metric-header">
                    <div class="sr-metric-icon score">
                        <i class="bi bi-speedometer2"></i>
                    </div>
                </div>
                {% set avg_score = (pages|selectattr('seo_score')|map(attribute='seo_score')|sum / (pages|selectattr('seo_score')|list|length if pages|selectattr('seo_score')|list|length > 0 else 1)) | round(1) %}
                <div class="sr-metric-value">{{ avg_score if pages|selectattr('seo_score')|list|length > 0 else 'N/A' }}</div>
                <div class="sr-metric-label">Score Medio Pagine</div>
                {% if pages|selectattr('seo_score')|list|length > 0 %}
                <div class="sr-metric-trend">
                    {{ pages|selectattr('seo_score')|selectattr('seo_score', 'ge', 80)|list|length }} pagine eccellenti
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Issues Analysis Section -->
        <div class="sr-section sr-fade-in">
            <div class="sr-section-header">
                <h2 class="sr-section-title">
                    <i class="bi bi-bug"></i>
                    Analisi Problemi SEO
                </h2>
                <p class="sr-section-subtitle">
                    Problemi rilevati categorizzati per severità e tipo. Totale: {{ issues|length }} problemi
                </p>
            </div>
            
            <div class="sr-section-body">
                {% if issues %}
                <!-- Issues Breakdown -->
                <div style="padding: 1.5rem; background: var(--sr-gray-50); border-bottom: 1px solid var(--sr-border);">
                    <div class="row">
                        <div class="col-md-3 col-6 mb-3">
                            <div class="text-center">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--sr-danger);">
                                    {{ issues|selectattr('severity', 'equalto', 'critical')|list|length }}
                                </div>
                                <div style="font-size: 0.875rem; color: var(--sr-text-muted);">Critici</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="text-center">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--sr-warning);">
                                    {{ issues|selectattr('severity', 'equalto', 'high')|list|length }}
                                </div>
                                <div style="font-size: 0.875rem; color: var(--sr-text-muted);">Alti</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="text-center">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--sr-info);">
                                    {{ issues|selectattr('severity', 'equalto', 'medium')|list|length }}
                                </div>
                                <div style="font-size: 0.875rem; color: var(--sr-text-muted);">Medi</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="text-center">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--sr-success);">
                                    {{ issues|selectattr('severity', 'equalto', 'low')|list|length }}
                                </div>
                                <div style="font-size: 0.875rem; color: var(--sr-text-muted);">Bassi</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Issues Organization Tabs -->
                <div class="sr-tabs">
                    <button class="sr-tab active" onclick="showIssuesView('severity')" id="severity-tab">
                        <i class="bi bi-bar-chart-steps"></i>
                        Per Severità
                    </button>
                    <button class="sr-tab" onclick="showIssuesView('type')" id="type-tab">
                        <i class="bi bi-diagram-3"></i>
                        Per Tipologia
                    </button>
                </div>
                
                <!-- Issues by Severity View with NESTED ACCORDION -->
                <div id="issues-by-severity" class="sr-tab-content">
                    {% set severity_order = ['critical', 'high', 'medium', 'low'] %}
                    {% set severity_names = {'critical': 'Critici', 'high': 'Alta Priorità', 'medium': 'Media Priorità', 'low': 'Bassa Priorità'} %}
                    {% set severity_icons = {'critical': 'exclamation-circle', 'high': 'exclamation-triangle', 'medium': 'info-circle', 'low': 'check-circle'} %}
                    
                    {% for severity in severity_order %}
                        {% if issues_hierarchy.get(severity) %}
                        <div class="accordion-item" style="margin-bottom: 1rem;">
                            <!-- LEVEL 1: Severity Accordion -->
                            <div class="accordion-header" onclick="toggleAccordion('severity-{{ severity }}')" 
                                 style="background: var(--sr-gray-50); border: 1px solid var(--sr-border); border-radius: 8px; padding: 1rem; cursor: pointer; user-select: none;">
                                <div style="display: flex; justify-content: between; align-items: center;">
                                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                                        <span class="sr-badge {{ severity }}">
                                            <i class="bi bi-{{ severity_icons[severity] }}"></i>
                                            {{ severity_names[severity] }}
                                        </span>
                                        {% set total_issues_in_severity = issues_hierarchy[severity].values() | map(attribute='count') | sum %}
                                        <span style="font-weight: 600; color: var(--sr-text);">
                                            {{ total_issues_in_severity }} problema{{ 'i' if total_issues_in_severity != 1 else '' }}
                                        </span>
                                        <!-- Show issue types preview -->
                                        <span style="font-size: 0.875rem; color: var(--sr-text-muted);">
                                            ({{ issues_hierarchy[severity].keys() | length }} tipologie)
                                        </span>
                                    </div>
                                    <i class="bi bi-chevron-down accordion-icon" id="icon-severity-{{ severity }}" style="transition: transform 0.2s;"></i>
                                </div>
                            </div>
                            
                            <!-- LEVEL 2: Issue Types Nested Accordion -->
                            <div class="accordion-content" id="content-severity-{{ severity }}" style="display: none; border: 1px solid var(--sr-border); border-top: none; border-radius: 0 0 8px 8px; background: var(--sr-white);">
                                {% for issue_type, issue_data in issues_hierarchy[severity].items() %}
                                <div class="nested-accordion-item" style="margin: 0.5rem; border: 1px solid var(--sr-border-light); border-radius: 6px;">
                                    <!-- Issue Type Header -->
                                    <div class="nested-accordion-header" onclick="toggleNestedAccordion('{{ severity }}-{{ issue_type }}')" 
                                         style="background: var(--sr-gray-25); padding: 0.75rem; cursor: pointer; user-select: none; border-radius: 6px 6px 0 0;">
                                        <div style="display: flex; justify-content: between; align-items: center;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <i class="{{ issue_data.icon }}" style="color: var(--sr-primary); font-size: 1rem;"></i>
                                                <span style="font-weight: 500; color: var(--sr-text); font-size: 0.9rem;">
                                                    {{ issue_data.title }}
                                                </span>
                                                <span class="sr-badge {{ severity }}" style="font-size: 0.75rem; padding: 0.125rem 0.375rem;">
                                                    {{ issue_data.count }} pagina{{ 'e' if issue_data.count != 1 else '' }}
                                                </span>
                                            </div>
                                            <i class="bi bi-chevron-down accordion-icon" id="icon-nested-{{ severity }}-{{ issue_type }}" style="transition: transform 0.2s; font-size: 0.875rem;"></i>
                                        </div>
                                        
                                        <!-- Issue Description Preview -->
                                        {% if issue_data.first_description %}
                                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--sr-text-muted); line-height: 1.3;">
                                            {{ issue_data.first_description[:100] }}{% if issue_data.first_description|length > 100 %}...{% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Pages List -->
                                    <div class="nested-accordion-content" id="content-nested-{{ severity }}-{{ issue_type }}" 
                                         style="display: none; padding: 0.75rem; background: var(--sr-white); border-top: 1px solid var(--sr-border-light); border-radius: 0 0 6px 6px;">
                                        
                                        <!-- Description and Recommendation -->
                                        {% if issue_data.first_description or issue_data.first_recommendation %}
                                        <div style="margin-bottom: 0.75rem; padding: 0.5rem; background: var(--sr-gray-25); border-radius: 4px; border-left: 3px solid var(--sr-{{ severity }});">
                                            {% if issue_data.first_description %}
                                            <div style="font-size: 0.85rem; color: var(--sr-text); margin-bottom: 0.25rem;">
                                                <strong>Problema:</strong> {{ issue_data.first_description }}
                                            </div>
                                            {% endif %}
                                            {% if issue_data.first_recommendation %}
                                            <div style="font-size: 0.85rem; color: var(--sr-text-muted);">
                                                <strong>Soluzione:</strong> {{ issue_data.first_recommendation }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Resource Details Table -->
                                        {% if issue_data.resource_details %}
                                        <div style="font-size: 0.875rem; font-weight: 500; color: var(--sr-text); margin-bottom: 0.75rem;">
                                            Risorse Interessate:
                                        </div>
                                        <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--sr-border-light); border-radius: 4px;">
                                            <table class="sr-table" style="margin: 0; font-size: 0.8rem;">
                                                <thead style="background: var(--sr-gray-25); position: sticky; top: 0;">
                                                    <tr>
                                                        <th style="width: 35%; padding: 0.5rem;">Pagina</th>
                                                        <th style="width: 35%; padding: 0.5rem;">Risorsa</th>
                                                        <th style="width: 20%; padding: 0.5rem;">Dettagli</th>
                                                        <th style="width: 10%; padding: 0.5rem;">Azione</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for resource in issue_data.resource_details %}
                                                    <tr style="border-bottom: 1px solid var(--sr-border-light);">
                                                        <td style="padding: 0.5rem; vertical-align: top;">
                                                            <a href="{{ resource.page_url }}" target="_blank" class="sr-url" 
                                                               style="font-size: 0.75rem; display: block;"
                                                               title="{{ resource.page_url }}">
                                                                <i class="bi bi-link-45deg" style="color: var(--sr-text-muted); margin-right: 0.25rem;"></i>
                                                                {{ resource.page_url|truncate(40, True, '...') }}
                                                            </a>
                                                        </td>
                                                        <td style="padding: 0.5rem; vertical-align: top;">
                                                            <div style="display: flex; align-items: center; gap: 0.25rem;">
                                                                {% if resource.resource_type == 'image' %}
                                                                <i class="bi bi-image" style="color: var(--sr-info); font-size: 0.875rem;"></i>
                                                                {% elif resource.resource_type == 'css' %}
                                                                <i class="bi bi-file-earmark-code" style="color: var(--sr-primary); font-size: 0.875rem;"></i>
                                                                {% elif resource.resource_type == 'javascript' %}
                                                                <i class="bi bi-file-earmark-text" style="color: var(--sr-warning); font-size: 0.875rem;"></i>
                                                                {% else %}
                                                                <i class="bi bi-file-earmark" style="color: var(--sr-text-muted); font-size: 0.875rem;"></i>
                                                                {% endif %}
                                                                <span style="font-size: 0.75rem; word-break: break-all;">
                                                                    {% if resource.resource_url|length > 45 %}
                                                                    <span title="{{ resource.resource_url }}">{{ resource.resource_url|truncate(45, True, '...') }}</span>
                                                                    {% else %}
                                                                    {{ resource.resource_url }}
                                                                    {% endif %}
                                                                </span>
                                                            </div>
                                                            {% if resource.page_context %}
                                                            <div style="font-size: 0.7rem; color: var(--sr-text-muted); margin-top: 0.25rem;">
                                                                {{ resource.page_context }}
                                                            </div>
                                                            {% endif %}
                                                        </td>
                                                        <td style="padding: 0.5rem; vertical-align: top;">
                                                            {% if resource.issue_specific_data %}
                                                            <div style="font-size: 0.7rem;">
                                                                {% if resource.issue_specific_data.get('current_alt') is defined %}
                                                                <div><strong>Alt:</strong> 
                                                                    {% if resource.issue_specific_data.current_alt %}
                                                                    "{{ resource.issue_specific_data.current_alt|truncate(20, True, '...') }}"
                                                                    {% else %}
                                                                    <em>Missing</em>
                                                                    {% endif %}
                                                                </div>
                                                                {% endif %}
                                                                {% if resource.issue_specific_data.get('current_width') %}
                                                                <div><strong>Size:</strong> {{ resource.issue_specific_data.current_width }}x{{ resource.issue_specific_data.current_height }}px</div>
                                                                {% endif %}
                                                                {% if resource.issue_specific_data.get('estimated_delay_ms') %}
                                                                <div><strong>Delay:</strong> {{ resource.issue_specific_data.estimated_delay_ms|round(0) }}ms</div>
                                                                {% endif %}
                                                                {% if resource.issue_specific_data.get('current_filename') %}
                                                                <div><strong>File:</strong> {{ resource.issue_specific_data.current_filename|truncate(15, True, '...') }}</div>
                                                                {% endif %}
                                                            </div>
                                                            {% endif %}
                                                        </td>
                                                        <td style="padding: 0.5rem; vertical-align: top; text-align: center;">
                                                            {% if resource.resource_type == 'image' and resource.issue_specific_data.get('current_alt') is defined %}
                                                            <i class="bi bi-pencil-square" style="color: var(--sr-primary); cursor: pointer; font-size: 0.875rem;" 
                                                               title="Add alt text"></i>
                                                            {% elif resource.resource_type in ['css', 'javascript'] %}
                                                            <i class="bi bi-code-square" style="color: var(--sr-warning); cursor: pointer; font-size: 0.875rem;" 
                                                               title="Optimize loading"></i>
                                                            {% else %}
                                                            <i class="bi bi-tools" style="color: var(--sr-info); cursor: pointer; font-size: 0.875rem;" 
                                                               title="Fix issue"></i>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        {% else %}
                                        <!-- Fallback to original pages list if no resource details -->
                                        <div style="font-size: 0.875rem; font-weight: 500; color: var(--sr-text); margin-bottom: 0.5rem;">
                                            Pagine Interessate:
                                        </div>
                                        <div style="max-height: 200px; overflow-y: auto;">
                                            {% for page_url in issue_data.pages %}
                                            <div style="padding: 0.25rem 0; border-bottom: 1px solid var(--sr-border-light); last-child:border-bottom: none;">
                                                <a href="{{ page_url }}" target="_blank" class="sr-url" 
                                                   style="font-size: 0.85rem; display: block; padding: 0.25rem 0.5rem; border-radius: 3px; text-decoration: none;"
                                                   onmouseover="this.style.background='var(--sr-gray-50)'" 
                                                   onmouseout="this.style.background='transparent'">
                                                    <i class="bi bi-link-45deg" style="color: var(--sr-text-muted); margin-right: 0.25rem;"></i>
                                                    {{ page_url }}
                                                </a>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                
                <!-- Issues by Type View -->
                <div id="issues-by-type" class="sr-tab-content" style="display: none;">
                    {% set issues_by_type = issues|groupby('type') %}
                    {% for issue_type, type_issues in issues_by_type %}
                    <div class="accordion-item" style="margin-bottom: 1rem;">
                        <div class="accordion-header" onclick="toggleAccordion('type-{{ loop.index }}')" 
                             style="background: var(--sr-gray-50); border: 1px solid var(--sr-border); border-radius: 8px; padding: 1rem; cursor: pointer; user-select: none;">
                            <div style="display: flex; justify-content: between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="bi bi-gear" style="color: var(--sr-primary);"></i>
                                        <span style="font-weight: 600; color: var(--sr-text);">
                                            {{ issue_type.replace('_', ' ').title() }}
                                        </span>
                                    </div>
                                    <span style="font-size: 0.875rem; color: var(--sr-text-muted);">
                                        {{ type_issues|list|length }} occorrenza{{ 'e' if type_issues|list|length != 1 else '' }}
                                    </span>
                                    <!-- Severity breakdown for this type -->
                                    <div style="display: flex; gap: 0.25rem;">
                                        {% set type_issues_list = type_issues|list %}
                                        {% for severity in ['critical', 'high', 'medium', 'low'] %}
                                            {% set count = type_issues_list|selectattr('severity', 'equalto', severity)|list|length %}
                                            {% if count > 0 %}
                                            <span class="sr-badge {{ severity }}" style="font-size: 0.75rem; padding: 0.125rem 0.375rem;">
                                                {{ count }}
                                            </span>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                <i class="bi bi-chevron-down accordion-icon" id="icon-type-{{ loop.index }}" style="transition: transform 0.2s;"></i>
                            </div>
                        </div>
                        <div class="accordion-content" id="content-type-{{ loop.index }}" style="display: none; border: 1px solid var(--sr-border); border-top: none; border-radius: 0 0 8px 8px;">
                            <div class="table-responsive">
                                <table class="sr-table" style="margin: 0;">
                                    <thead>
                                        <tr>
                                            <th style="width: 15%;">Severità</th>
                                            <th style="width: 55%;">Descrizione</th>
                                            <th style="width: 30%;">Pagina</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for issue in type_issues|list %}
                                        <tr>
                                            <td>
                                                <span class="sr-badge {{ issue.severity }}">
                                                    <i class="bi bi-{{ 'exclamation-circle' if issue.severity == 'critical' else 'exclamation-triangle' if issue.severity == 'high' else 'info-circle' if issue.severity == 'medium' else 'check-circle' }}"></i>
                                                    {{ issue.severity.title() }}
                                                </span>
                                            </td>
                                            <td>
                                                <div style="line-height: 1.4; font-size: 0.875rem;">{{ issue.message }}</div>
                                            </td>
                                            <td>
                                                <a href="{{ issue.page_url }}" target="_blank" class="sr-url" title="{{ issue.page_url }}">
                                                    {{ issue.page_url }}
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="sr-empty-state">
                    <div class="sr-empty-icon">
                        <i class="bi bi-check-circle-fill sr-text-success"></i>
                    </div>
                    <h3 class="sr-empty-title">Nessun Problema Rilevato</h3>
                    <p class="sr-empty-description">
                        Eccellente! Il sito non presenta problemi SEO significativi.
                    </p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Core Web Vitals Section -->
        {% if performance_overview and performance_overview.avg_performance_score > 0 %}
        <div class="sr-section sr-fade-in">
            <div class="sr-section-header">
                <h2 class="sr-section-title">
                    <i class="bi bi-speedometer2"></i>
                    Core Web Vitals & Performance
                </h2>
                <p class="sr-section-subtitle">
                    Analisi delle performance e dei Core Web Vitals per {{ performance_overview.pages_with_performance_data }} pagine
                </p>
            </div>
            
            <div class="sr-section-body">
                <!-- Performance Overview Cards -->
                <div class="row mb-4">
                    <div class="col-md-3 col-6 mb-3">
                        <div class="sr-performance-metric">
                            <div class="sr-metric-icon">
                                <i class="bi bi-speedometer2"></i>
                            </div>
                            <div class="sr-metric-value">{{ performance_overview.avg_performance_score }}/100</div>
                            <div class="sr-metric-label">Performance Media</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="sr-performance-metric">
                            <div class="sr-metric-icon">
                                <i class="bi bi-gear"></i>
                            </div>
                            <div class="sr-metric-value">{{ performance_overview.avg_technical_score }}/100</div>
                            <div class="sr-metric-label">SEO Tecnico Medio</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="sr-performance-metric">
                            <div class="sr-metric-icon">
                                <i class="bi bi-phone"></i>
                            </div>
                            <div class="sr-metric-value">{{ performance_overview.mobile_coverage }}%</div>
                            <div class="sr-metric-label">Mobile Optimization</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="sr-performance-metric">
                            <div class="sr-metric-icon">
                                <i class="bi bi-code-square"></i>
                            </div>
                            <div class="sr-metric-value">{{ performance_overview.schema_coverage }}%</div>
                            <div class="sr-metric-label">Schema Markup</div>
                        </div>
                    </div>
                </div>
                
                <!-- Sample Core Web Vitals data from first page -->
                {% set sample_page = pages[0] if pages else None %}
                {% if sample_page and sample_page.core_web_vitals %}
                    {% set cwv_data = sample_page.core_web_vitals %}
                    {% set scores = cwv_data.get('scores', {}) %}
                    
                    <!-- Display sample Core Web Vitals -->
                    <div class="row">
                        {% if scores.get('lcp') %}
                        <div class="col-md-2 col-6 mb-3">
                            <div class="sr-cwv-mini {{ 'good' if scores.lcp.rating == 'good' else 'needs-improvement' if scores.lcp.rating == 'needs_improvement' else 'poor' }}">
                                <div class="sr-cwv-acronym">LCP</div>
                                <div class="sr-cwv-value">{{ scores.lcp.value|round(2) }}s</div>
                                <div class="sr-cwv-rating">{{ scores.lcp.rating.replace('_', ' ').title() }}</div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if scores.get('fid') %}
                        <div class="col-md-2 col-6 mb-3">
                            <div class="sr-cwv-mini {{ 'good' if scores.fid.rating == 'good' else 'needs-improvement' if scores.fid.rating == 'needs_improvement' else 'poor' }}">
                                <div class="sr-cwv-acronym">FID</div>
                                <div class="sr-cwv-value">{{ scores.fid.value|round(0) }}ms</div>
                                <div class="sr-cwv-rating">{{ scores.fid.rating.replace('_', ' ').title() }}</div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if scores.get('cls') %}
                        <div class="col-md-2 col-6 mb-3">
                            <div class="sr-cwv-mini {{ 'good' if scores.cls.rating == 'good' else 'needs-improvement' if scores.cls.rating == 'needs_improvement' else 'poor' }}">
                                <div class="sr-cwv-acronym">CLS</div>
                                <div class="sr-cwv-value">{{ scores.cls.value|round(3) }}</div>
                                <div class="sr-cwv-rating">{{ scores.cls.rating.replace('_', ' ').title() }}</div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if scores.get('fcp') %}
                        <div class="col-md-2 col-6 mb-3">
                            <div class="sr-cwv-mini {{ 'good' if scores.fcp.rating == 'good' else 'needs-improvement' if scores.fcp.rating == 'needs_improvement' else 'poor' }}">
                                <div class="sr-cwv-acronym">FCP</div>
                                <div class="sr-cwv-value">{{ scores.fcp.value|round(2) }}s</div>
                                <div class="sr-cwv-rating">{{ scores.fcp.rating.replace('_', ' ').title() }}</div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if scores.get('ttfb') %}
                        <div class="col-md-2 col-6 mb-3">
                            <div class="sr-cwv-mini {{ 'good' if scores.ttfb.rating == 'good' else 'needs-improvement' if scores.ttfb.rating == 'needs_improvement' else 'poor' }}">
                                <div class="sr-cwv-acronym">TTFB</div>
                                <div class="sr-cwv-value">{{ scores.ttfb.value|round(0) }}ms</div>
                                <div class="sr-cwv-rating">{{ scores.ttfb.rating.replace('_', ' ').title() }}</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Technical SEO Overview Section -->
        {% if performance_overview and performance_overview.avg_technical_score > 0 %}
        <div class="sr-section sr-fade-in">
            <div class="sr-section-header">
                <h2 class="sr-section-title">
                    <i class="bi bi-gear-fill"></i>
                    Technical SEO Overview
                </h2>
                <p class="sr-section-subtitle">
                    Analisi tecnica SEO per {{ performance_overview.pages_with_technical_data }} pagine
                </p>
            </div>
            
            <div class="sr-section-body">
                <!-- Technical Overview Grid -->
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="sr-tech-overview-card">
                            <h4><i class="bi bi-code-square"></i> Schema Markup</h4>
                            <div class="sr-tech-stats">
                                <div class="sr-stat-item">
                                    <span class="sr-stat-value">{{ performance_overview.schema_coverage }}%</span>
                                    <span class="sr-stat-label">Pagine con Schema</span>
                                </div>
                                {% set total_schema_pages = (performance_overview.schema_coverage / 100 * performance_overview.total_pages_analyzed)|round %}
                                <div class="sr-stat-item">
                                    <span class="sr-stat-value">{{ total_schema_pages|int }}/{{ performance_overview.total_pages_analyzed }}</span>
                                    <span class="sr-stat-label">Pagine Implementate</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                        <div class="sr-tech-overview-card">
                            <h4><i class="bi bi-phone"></i> Mobile Optimization</h4>
                            <div class="sr-tech-stats">
                                <div class="sr-stat-item">
                                    <span class="sr-stat-value">{{ performance_overview.mobile_coverage }}%</span>
                                    <span class="sr-stat-label">Pagine Ottimizzate</span>
                                </div>
                                {% set total_mobile_pages = (performance_overview.mobile_coverage / 100 * performance_overview.total_pages_analyzed)|round %}
                                <div class="sr-stat-item">
                                    <span class="sr-stat-value">{{ total_mobile_pages|int }}/{{ performance_overview.total_pages_analyzed }}</span>
                                    <span class="sr-stat-label">Mobile Ready</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sample Technical SEO data -->
                {% set sample_page = pages[0] if pages else None %}
                {% if sample_page and sample_page.technical_seo_data %}
                    {% set tech_data = sample_page.technical_seo_data %}
                    {% set schema_data = tech_data.get('schema_markup', {}) %}
                    {% set social_data = tech_data.get('social_meta_tags', {}) %}
                    
                    <div class="sr-tech-sample">
                        <h5><i class="bi bi-eye"></i> Esempio Analisi Tecnica (Prima Pagina)</h5>
                        <div class="row">
                            {% if schema_data.get('schema_types') %}
                            <div class="col-md-4 mb-3">
                                <div class="sr-tech-detail">
                                    <strong>Schema Types Found:</strong>
                                    <div class="sr-schema-tags">
                                        {% for schema_type in schema_data.schema_types[:3] %}
                                        <span class="sr-schema-tag">{{ schema_type }}</span>
                                        {% endfor %}
                                        {% if schema_data.schema_types|length > 3 %}
                                        <span class="sr-schema-tag">+{{ schema_data.schema_types|length - 3 }} more</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if social_data.get('overall_coverage') %}
                            <div class="col-md-4 mb-3">
                                <div class="sr-tech-detail">
                                    <strong>Social Meta Coverage:</strong>
                                    <div class="sr-coverage-bar">
                                        <div class="sr-coverage-fill" style="width: {{ social_data.overall_coverage }}%"></div>
                                        <span class="sr-coverage-text">{{ social_data.overall_coverage|round(1) }}%</span>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if sample_page.mobile_score %}
                            <div class="col-md-4 mb-3">
                                <div class="sr-tech-detail">
                                    <strong>Mobile Score:</strong>
                                    <div class="sr-mobile-score {{ 'good' if sample_page.mobile_score >= 70 else 'needs-improvement' if sample_page.mobile_score >= 40 else 'poor' }}">
                                        {{ sample_page.mobile_score|round(1) }}/100
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Pages Performance Section -->
        <div class="sr-section sr-fade-in">
            <div class="sr-section-header">
                <h2 class="sr-section-title">
                    <i class="bi bi-speedometer2"></i>
                    Performance delle Pagine
                </h2>
                <p class="sr-section-subtitle">
                    {% if pagination %}
                    Mostrando pagine {{ pagination.start_item }}-{{ pagination.end_item }} di {{ pagination.total_items }} totali
                    (Pagina {{ pagination.current_page }} di {{ pagination.total_pages }})
                    {% else %}
                    Analisi dettagliata delle {{ pages|length }} pagine scansionate con score SEO e problemi per pagina
                    {% endif %}
                </p>
            </div>
            
            <div class="sr-section-body">
                {% if pages %}
                <div class="table-responsive">
                    <table class="sr-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">URL</th>
                                <th style="width: 25%;">Titolo Pagina</th>
                                <th style="width: 10%;">Status</th>
                                <th style="width: 15%;">Score SEO</th>
                                <th style="width: 10%;">Problemi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for page in pages|sort(attribute='seo_score', reverse=true) %}
                            <tr>
                                <td>
                                    <a href="{{ page.url }}" target="_blank" class="sr-url" title="{{ page.url }}">
                                        {{ page.url }}
                                    </a>
                                </td>
                                <td>
                                    <div class="sr-truncate" style="max-width: 200px;" title="{{ page.title or 'Nessun titolo' }}">
                                        {{ page.title or 'Nessun titolo' }}
                                    </div>
                                </td>
                                <td>
                                    <span class="sr-badge status-{{ page.status_code if page.status_code else '000' }}">
                                        {{ page.status_code or '000' }}
                                    </span>
                                </td>
                                <td>
                                    {% if page.seo_score %}
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <div class="sr-progress" style="width: 50px;">
                                            <div class="sr-progress-bar {{ 'excellent' if page.seo_score >= 80 else 'good' if page.seo_score >= 60 else 'fair' if page.seo_score >= 40 else 'poor' }}" 
                                                 style="width: {{ page.seo_score }}%;"></div>
                                        </div>
                                        <span style="font-weight: 500; min-width: 35px;">{{ page.seo_score }}</span>
                                    </div>
                                    {% else %}
                                    <span class="sr-text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if page.issues_count > 0 %}
                                    <span class="sr-badge {{ 'critical' if page.issues_count >= 10 else 'high' if page.issues_count >= 5 else 'medium' }}">
                                        {{ page.issues_count }}
                                    </span>
                                    {% else %}
                                    <span class="sr-badge low">
                                        <i class="bi bi-check"></i> 0
                                    </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Controls -->
                {% if pagination and pagination.total_pages > 1 %}
                <div style="padding: 1.5rem; border-top: 1px solid var(--sr-border); background: var(--sr-gray-50);">
                    <div style="display: flex; justify-content: between; align-items: center; gap: 1rem;">
                        <!-- Left: Items info -->
                        <div style="font-size: 0.875rem; color: var(--sr-text-muted);">
                            Mostrando {{ pagination.start_item }}-{{ pagination.end_item }} di {{ pagination.total_items }}
                        </div>
                        
                        <!-- Center: Page controls -->
                        <div style="display: flex; gap: 0.5rem; align-items: center; margin-left: auto;">
                            <!-- Previous button -->
                            {% if pagination.has_prev %}
                            <a href="/templated/scan/{{ scan.id }}/results?page={{ pagination.prev_page }}" 
                               class="sr-btn sr-btn-outline" style="padding: 0.5rem 0.75rem;">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                            {% else %}
                            <span class="sr-btn sr-btn-outline" style="padding: 0.5rem 0.75rem; opacity: 0.5; cursor: not-allowed;">
                                <i class="bi bi-chevron-left"></i>
                            </span>
                            {% endif %}
                            
                            <!-- Page numbers -->
                            {% set start_page = (pagination.current_page - 2) if pagination.current_page > 2 else 1 %}
                            {% set end_page = (pagination.current_page + 2) if (pagination.current_page + 2) <= pagination.total_pages else pagination.total_pages %}
                            
                            {% if start_page > 1 %}
                            <a href="/templated/scan/{{ scan.id }}/results?page=1" 
                               class="sr-btn sr-btn-outline" style="padding: 0.5rem 0.75rem; min-width: 40px;">1</a>
                            {% if start_page > 2 %}
                            <span style="padding: 0.5rem; color: var(--sr-text-muted);">...</span>
                            {% endif %}
                            {% endif %}
                            
                            {% for page_num in range(start_page, end_page + 1) %}
                            {% if page_num == pagination.current_page %}
                            <span class="sr-btn sr-btn-primary" style="padding: 0.5rem 0.75rem; min-width: 40px;">{{ page_num }}</span>
                            {% else %}
                            <a href="/templated/scan/{{ scan.id }}/results?page={{ page_num }}" 
                               class="sr-btn sr-btn-outline" style="padding: 0.5rem 0.75rem; min-width: 40px;">{{ page_num }}</a>
                            {% endif %}
                            {% endfor %}
                            
                            {% if end_page < pagination.total_pages %}
                            {% if end_page < pagination.total_pages - 1 %}
                            <span style="padding: 0.5rem; color: var(--sr-text-muted);">...</span>
                            {% endif %}
                            <a href="/templated/scan/{{ scan.id }}/results?page={{ pagination.total_pages }}" 
                               class="sr-btn sr-btn-outline" style="padding: 0.5rem 0.75rem; min-width: 40px;">{{ pagination.total_pages }}</a>
                            {% endif %}
                            
                            <!-- Next button -->
                            {% if pagination.has_next %}
                            <a href="/templated/scan/{{ scan.id }}/results?page={{ pagination.next_page }}" 
                               class="sr-btn sr-btn-outline" style="padding: 0.5rem 0.75rem;">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                            {% else %}
                            <span class="sr-btn sr-btn-outline" style="padding: 0.5rem 0.75rem; opacity: 0.5; cursor: not-allowed;">
                                <i class="bi bi-chevron-right"></i>
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- Right: Per page selector -->
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 0.875rem; color: var(--sr-text-muted);">Per pagina:</span>
                            <select onchange="changePagination(this.value)" style="padding: 0.25rem 0.5rem; border: 1px solid var(--sr-border); border-radius: 4px; font-size: 0.875rem;">
                                <option value="25" {% if pagination.per_page == 25 %}selected{% endif %}>25</option>
                                <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50</option>
                                <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100</option>
                                <option value="200" {% if pagination.per_page == 200 %}selected{% endif %}>200</option>
                            </select>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% else %}
                <div class="sr-empty-state">
                    <div class="sr-empty-icon">
                        <i class="bi bi-file-earmark-x"></i>
                    </div>
                    <h3 class="sr-empty-title">Nessuna Pagina Scansionata</h3>
                    <p class="sr-empty-description">
                        La scansione potrebbe essere ancora in corso o non è riuscita a trovare pagine.
                    </p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Smart Issue Prioritization Matrix -->
        {% if priority_data and priority_data.summary.total_issues > 0 %}
        <div class="sr-section sr-fade-in">
            {% include 'components/priority_matrix.html' %}
        </div>
        {% endif %}

        <!-- Quick Actions & Summary -->
        <div class="sr-section sr-fade-in">
            <div class="sr-section-header">
                <h2 class="sr-section-title">
                    <i class="bi bi-lightning"></i>
                    Prossimi Passi Consigliati
                </h2>
                <p class="sr-section-subtitle">
                    Azioni prioritarie basate sui risultati della scansione
                </p>
            </div>
            
            <div class="sr-section-body" style="padding: 1.5rem;">
                {% set critical_count = issues|selectattr('severity', 'equalto', 'critical')|list|length %}
                {% set high_count = issues|selectattr('severity', 'equalto', 'high')|list|length %}
                
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h4 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: var(--sr-text);">
                            <i class="bi bi-star"></i> Priorità Alta
                        </h4>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            {% if critical_count > 0 %}
                            <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--sr-border);">
                                <i class="bi bi-exclamation-triangle" style="color: var(--sr-danger); margin-right: 0.5rem;"></i>
                                Risolvere {{ critical_count }} problema{{ 's' if critical_count != 1 else '' }} critico{{ 's' if critical_count != 1 else '' }}
                            </li>
                            {% endif %}
                            {% if high_count > 0 %}
                            <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--sr-border);">
                                <i class="bi bi-exclamation-circle" style="color: var(--sr-warning); margin-right: 0.5rem;"></i>
                                Gestire {{ high_count }} problema{{ 's' if high_count != 1 else '' }} ad alta priorità
                            </li>
                            {% endif %}
                            {% if not critical_count and not high_count %}
                            <li style="padding: 0.5rem 0;">
                                <i class="bi bi-check-circle" style="color: var(--sr-success); margin-right: 0.5rem;"></i>
                                Nessun problema critico o ad alta priorità
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                        <h4 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: var(--sr-text);">
                            <i class="bi bi-graph-up"></i> Ottimizzazioni
                        </h4>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            {% set low_score_pages = pages|selectattr('seo_score')|selectattr('seo_score', 'lt', 60)|list|length %}
                            {% if low_score_pages > 0 %}
                            <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--sr-border);">
                                <i class="bi bi-speedometer" style="color: var(--sr-info); margin-right: 0.5rem;"></i>
                                Migliorare {{ low_score_pages }} pagina{{ 's' if low_score_pages != 1 else '' }} con score basso
                            </li>
                            {% endif %}
                            <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--sr-border);">
                                <i class="bi bi-download" style="color: var(--sr-primary); margin-right: 0.5rem;"></i>
                                Scaricare il report PDF completo
                            </li>
                            <li style="padding: 0.5rem 0;">
                                <i class="bi bi-arrow-repeat" style="color: var(--sr-info); margin-right: 0.5rem;"></i>
                                Programmare scansione di follow-up
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--sr-border); text-align: center;">
                    <a href="/api/v1/scans/{{ scan.id }}/report" class="sr-btn sr-btn-primary" target="_blank" style="margin-right: 1rem;">
                        <i class="bi bi-download"></i>
                        Scarica Report Completo
                    </a>
                    <a href="/templated/scans" class="sr-btn sr-btn-outline">
                        <i class="bi bi-plus-circle"></i>
                        Avvia Nuova Scansione
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Error State -->
    <div class="container-fluid">
        <div class="sr-section">
            <div class="sr-empty-state">
                <div class="sr-empty-icon">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <h3 class="sr-empty-title">Scansione Non Trovata</h3>
                <p class="sr-empty-description">
                    La scansione richiesta non esiste o non è più accessibile.
                </p>
                <div style="margin-top: 2rem;">
                    <a href="/templated/scans" class="sr-btn sr-btn-primary">
                        <i class="bi bi-arrow-left"></i>
                        Torna alle Scansioni
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>


<script>
// Enhanced JavaScript for SEMrush-style accordion and tabs
document.addEventListener('DOMContentLoaded', function() {
    // Add fade-in animation delays
    const elements = document.querySelectorAll('.sr-fade-in');
    elements.forEach((el, index) => {
        el.style.animationDelay = `${index * 0.1}s`;
    });
    
    // Add hover effects for metric cards
    const metricCards = document.querySelectorAll('.sr-metric-card');
    metricCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-4px)';
            this.style.boxShadow = 'var(--sr-shadow-lg)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '';
        });
    });
    
    // Smooth scroll for internal links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});

// Tab switching functionality
function showIssuesView(viewType) {
    // Hide all tab contents
    document.getElementById('issues-by-severity').style.display = 'none';
    document.getElementById('issues-by-type').style.display = 'none';
    
    // Remove active class from all tabs
    document.getElementById('severity-tab').classList.remove('active');
    document.getElementById('type-tab').classList.remove('active');
    
    // Show selected view and activate tab
    if (viewType === 'severity') {
        document.getElementById('issues-by-severity').style.display = 'block';
        document.getElementById('severity-tab').classList.add('active');
    } else if (viewType === 'type') {
        document.getElementById('issues-by-type').style.display = 'block';
        document.getElementById('type-tab').classList.add('active');
    }
}

// Accordion functionality
function toggleAccordion(accordionId) {
    const content = document.getElementById('content-' + accordionId);
    const icon = document.getElementById('icon-' + accordionId);
    
    if (content.style.display === 'none' || content.style.display === '') {
        // Open accordion
        content.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
        
        // Add smooth opening animation
        content.style.opacity = '0';
        content.style.maxHeight = '0';
        content.style.overflow = 'hidden';
        content.style.transition = 'all 0.3s ease-in-out';
        
        setTimeout(() => {
            content.style.opacity = '1';
            content.style.maxHeight = 'none';
        }, 10);
    } else {
        // Close accordion
        content.style.maxHeight = content.scrollHeight + 'px';
        content.style.transition = 'all 0.3s ease-in-out';
        
        setTimeout(() => {
            content.style.opacity = '0';
            content.style.maxHeight = '0';
        }, 10);
        
        setTimeout(() => {
            content.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }, 300);
    }
}

// Nested accordion functionality for double accordion (Level 2)
function toggleNestedAccordion(nestedId) {
    const content = document.getElementById('content-nested-' + nestedId);
    const icon = document.getElementById('icon-nested-' + nestedId);
    
    if (!content || !icon) {
        console.warn('Nested accordion elements not found for ID:', nestedId);
        return;
    }
    
    if (content.style.display === 'none' || content.style.display === '') {
        // Open nested accordion
        content.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
        
        // Add smooth opening animation
        content.style.opacity = '0';
        content.style.maxHeight = '0';
        content.style.overflow = 'hidden';
        content.style.transition = 'all 0.3s ease-in-out';
        
        setTimeout(() => {
            content.style.opacity = '1';
            content.style.maxHeight = 'none';
        }, 10);
    } else {
        // Close nested accordion
        content.style.maxHeight = content.scrollHeight + 'px';
        content.style.transition = 'all 0.3s ease-in-out';
        
        setTimeout(() => {
            content.style.opacity = '0';
            content.style.maxHeight = '0';
        }, 10);
        
        setTimeout(() => {
            content.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }, 300);
    }
}

// Auto-expand critical issues on load
document.addEventListener('DOMContentLoaded', function() {
    // Auto-expand critical issues if they exist
    const criticalContent = document.getElementById('content-severity-critical');
    if (criticalContent) {
        setTimeout(() => {
            toggleAccordion('severity-critical');
        }, 500);
    }
});

// Pagination functionality
function changePagination(perPage) {
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.set('per_page', perPage);
    currentUrl.searchParams.set('page', '1'); // Reset to first page
    window.location.href = currentUrl.toString();
}
</script>