<!-- Smart Priority Matrix - Visual Issue Prioritization Component -->
<div class="sr-priority-matrix-container">
    <div class="sr-priority-matrix-header">
        <h3>
            <i class="bi bi-diagram-3"></i>
            Smart Issue Prioritization
        </h3>
        <p class="sr-matrix-subtitle">
            Analisi intelligente di priorit√† basata su impatto business e effort richiesto
        </p>
    </div>

    <!-- Priority Summary Cards -->
    <div class="sr-priority-summary">
        <div class="sr-summary-card sr-critical">
            <div class="sr-summary-icon">
                <i class="bi bi-exclamation-triangle-fill"></i>
            </div>
            <div class="sr-summary-content">
                <div class="sr-summary-number">{{ priority_data.summary.critical_count }}</div>
                <div class="sr-summary-label">Critici</div>
            </div>
        </div>
        
        <div class="sr-summary-card sr-quick-wins">
            <div class="sr-summary-icon">
                <i class="bi bi-lightning-fill"></i>
            </div>
            <div class="sr-summary-content">
                <div class="sr-summary-number">{{ priority_data.summary.quick_wins_count }}</div>
                <div class="sr-summary-label">Quick Wins</div>
            </div>
        </div>
        
        <div class="sr-summary-card sr-major-projects">
            <div class="sr-summary-icon">
                <i class="bi bi-gear-wide-connected"></i>
            </div>
            <div class="sr-summary-content">
                <div class="sr-summary-number">{{ priority_data.summary.major_projects_count }}</div>
                <div class="sr-summary-label">Major Projects</div>
            </div>
        </div>
        
        <div class="sr-summary-card sr-total">
            <div class="sr-summary-icon">
                <i class="bi bi-list-check"></i>
            </div>
            <div class="sr-summary-content">
                <div class="sr-summary-number">{{ priority_data.summary.total_issues }}</div>
                <div class="sr-summary-label">Totali</div>
            </div>
        </div>
    </div>

    <!-- Interactive Priority Matrix -->
    <div class="sr-matrix-container">
        <div class="sr-matrix-wrapper">
            <!-- Y-axis label (Effort) -->
            <div class="sr-axis-label sr-y-axis">
                <span>EFFORT</span>
                <div class="sr-axis-scale">
                    <span>Alto</span>
                    <span>Basso</span>
                </div>
            </div>
            
            <!-- Main matrix area -->
            <div class="sr-matrix-area">
                <!-- X-axis label (Impact) -->
                <div class="sr-x-axis-label">
                    <span>IMPACT</span>
                    <div class="sr-axis-scale">
                        <span>Basso</span>
                        <span>Alto</span>
                    </div>
                </div>
                
                <!-- Matrix grid with quadrants -->
                <div class="sr-matrix-grid" id="priorityMatrix">
                    <!-- Quadrant labels -->
                    <div class="sr-quadrant-label sr-q1">
                        <strong>Major Projects</strong>
                        <small>Alto Impatto, Alto Effort</small>
                    </div>
                    <div class="sr-quadrant-label sr-q2">
                        <strong>Quick Wins</strong>
                        <small>Alto Impatto, Basso Effort</small>
                    </div>
                    <div class="sr-quadrant-label sr-q3">
                        <strong>Thankless Tasks</strong>
                        <small>Basso Impatto, Alto Effort</small>
                    </div>
                    <div class="sr-quadrant-label sr-q4">
                        <strong>Fill-ins</strong>
                        <small>Basso Impatto, Basso Effort</small>
                    </div>
                    
                    <!-- Issues plotted as bubbles -->
                    {% if priority_data.priority_matrix.all_issues %}
                    {% for issue in priority_data.priority_matrix.all_issues %}
                    <div class="sr-issue-bubble sr-priority-{{ issue.priority }} sr-category-{{ issue.category }}"
                         style="left: {{ issue.x }}%; bottom: {{ issue.y }}%;"
                         data-issue-id="{{ issue.id }}"
                         data-bs-toggle="tooltip"
                         title="{{ issue.title }}">
                        <div class="sr-bubble-content">
                            <i class="bi bi-{{ 'exclamation-triangle' if issue.priority == 'critical' else 'star' if issue.priority == 'high' else 'check-circle' if issue.priority == 'medium' else 'circle' }}"></i>
                        </div>
                        <div class="sr-bubble-priority">{{ issue.priority_score }}</div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Issue Details Panel -->
    <div class="sr-issue-details-panel" id="issueDetailsPanel" style="display: none;">
        <div class="sr-issue-details-header">
            <h4 id="issueTitle">Issue Details</h4>
            <button class="sr-close-details" onclick="closeIssueDetails()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        
        <div class="sr-issue-details-content">
            <div class="sr-detail-section">
                <h5>Priority Assessment</h5>
                <div class="sr-priority-badges">
                    <span class="sr-badge" id="issuePriority">High</span>
                    <span class="sr-badge" id="issueImpact">High Impact</span>
                    <span class="sr-badge" id="issueEffort">Medium Effort</span>
                </div>
            </div>
            
            <div class="sr-detail-section">
                <h5>Business Impact</h5>
                <p id="businessImpact">This issue affects...</p>
            </div>
            
            <div class="sr-detail-section">
                <h5>Traffic Impact</h5>
                <p id="trafficImpact">Potential improvement...</p>
            </div>
            
            <div class="sr-detail-section">
                <h5>Technical Complexity</h5>
                <p id="technicalComplexity">Requires...</p>
            </div>
            
            <div class="sr-detail-section">
                <h5>Recommendation</h5>
                <p id="issueRecommendation">To fix this issue...</p>
            </div>
            
            <div class="sr-detail-section">
                <h5>Affected Pages</h5>
                <p id="affectedPages">1 page affected</p>
                <a href="#" id="pageUrl" target="_blank" class="sr-page-link">View Page</a>
            </div>
        </div>
    </div>

    <!-- Quadrant-based Issue Lists -->
    <div class="sr-quadrant-lists">
        <div class="sr-quadrant-list">
            <h4 class="sr-quadrant-title sr-quick-wins-title">
                <i class="bi bi-lightning-fill"></i>
                Quick Wins ({{ priority_data.priority_matrix.quadrants.quick_wins | length }})
            </h4>
            <div class="sr-issues-list">
                {% for issue in priority_data.priority_matrix.quadrants.quick_wins[:5] %}
                <div class="sr-issue-item sr-quick-win">
                    <div class="sr-issue-priority sr-priority-{{ issue.priority }}">
                        {{ issue.priority_score }}
                    </div>
                    <div class="sr-issue-content">
                        <strong>{{ issue.message[:50] }}{% if issue.message|length > 50 %}...{% endif %}</strong>
                        <p>{{ issue.description[:80] }}{% if issue.description|length > 80 %}...{% endif %}</p>
                        <div class="sr-issue-meta">
                            <span class="sr-category">{{ issue.category.replace('_', ' ').title() }}</span>
                            <span class="sr-complexity">{{ issue.effort.value.title() }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% if priority_data.priority_matrix.quadrants.quick_wins | length > 5 %}
                <div class="sr-show-more">
                    <button class="sr-btn-link" onclick="showAllQuickWins()">
                        Mostra tutti i {{ priority_data.priority_matrix.quadrants.quick_wins | length }} Quick Wins
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="sr-quadrant-list">
            <h4 class="sr-quadrant-title sr-major-projects-title">
                <i class="bi bi-gear-wide-connected"></i>
                Major Projects ({{ priority_data.priority_matrix.quadrants.major_projects | length }})
            </h4>
            <div class="sr-issues-list">
                {% for issue in priority_data.priority_matrix.quadrants.major_projects[:3] %}
                <div class="sr-issue-item sr-major-project">
                    <div class="sr-issue-priority sr-priority-{{ issue.priority }}">
                        {{ issue.priority_score }}
                    </div>
                    <div class="sr-issue-content">
                        <strong>{{ issue.message[:50] }}{% if issue.message|length > 50 %}...{% endif %}</strong>
                        <p>{{ issue.description[:80] }}{% if issue.description|length > 80 %}...{% endif %}</p>
                        <div class="sr-issue-meta">
                            <span class="sr-category">{{ issue.category.replace('_', ' ').title() }}</span>
                            <span class="sr-complexity">{{ issue.effort.value.title() }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% if priority_data.priority_matrix.quadrants.major_projects | length > 3 %}
                <div class="sr-show-more">
                    <button class="sr-btn-link" onclick="showAllMajorProjects()">
                        Mostra tutti i {{ priority_data.priority_matrix.quadrants.major_projects | length }} Major Projects
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Priority Matrix JavaScript -->
<script>
// Priority Matrix Data
const priorityMatrixData = {{ priority_data.priority_matrix.all_issues | tojson | safe }};

// Initialize Priority Matrix
document.addEventListener('DOMContentLoaded', function() {
    initializePriorityMatrix();
    setupMatrixInteractions();
});

function initializePriorityMatrix() {
    const matrix = document.getElementById('priorityMatrix');
    if (!matrix) return;
    
    // Add hover effects and click handlers to issue bubbles
    const bubbles = matrix.querySelectorAll('.sr-issue-bubble');
    bubbles.forEach(bubble => {
        bubble.addEventListener('click', function() {
            const issueId = this.dataset.issueId;
            showIssueDetails(issueId);
        });
        
        bubble.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.2)';
            this.style.zIndex = '100';
        });
        
        bubble.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
            this.style.zIndex = '10';
        });
    });
}

function setupMatrixInteractions() {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
}

function showIssueDetails(issueId) {
    const issue = priorityMatrixData.find(i => i.id === issueId);
    if (!issue) return;
    
    // Populate issue details panel
    document.getElementById('issueTitle').textContent = issue.title;
    document.getElementById('issuePriority').textContent = issue.priority.toUpperCase();
    document.getElementById('issuePriority').className = 'sr-badge sr-priority-' + issue.priority;
    document.getElementById('issueImpact').textContent = issue.impact.toUpperCase() + ' IMPACT';
    document.getElementById('issueEffort').textContent = issue.effort.toUpperCase() + ' EFFORT';
    document.getElementById('businessImpact').textContent = issue.business_impact;
    document.getElementById('trafficImpact').textContent = issue.traffic_impact;
    document.getElementById('technicalComplexity').textContent = issue.technical_complexity;
    document.getElementById('issueRecommendation').textContent = issue.recommendation;
    document.getElementById('affectedPages').textContent = issue.affected_pages + ' pagine interessate';
    document.getElementById('pageUrl').href = issue.page_url;
    document.getElementById('pageUrl').textContent = issue.page_url;
    
    // Show the panel
    document.getElementById('issueDetailsPanel').style.display = 'block';
    
    // Scroll to panel
    document.getElementById('issueDetailsPanel').scrollIntoView({ 
        behavior: 'smooth',
        block: 'nearest'
    });
}

function closeIssueDetails() {
    document.getElementById('issueDetailsPanel').style.display = 'none';
}

function showAllQuickWins() {
    // Implementation for showing all quick wins in a modal
    alert('Feature coming soon: View all Quick Wins');
}

function showAllMajorProjects() {
    // Implementation for showing all major projects in a modal
    alert('Feature coming soon: View all Major Projects');
}
</script>

<!-- Priority Matrix CSS -->
<style>
.sr-priority-matrix-container {
    background: white;
    border-radius: 16px;
    padding: 24px;
    margin: 24px 0;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid #e0e0e0;
}

.sr-priority-matrix-header {
    text-align: center;
    margin-bottom: 24px;
}

.sr-priority-matrix-header h3 {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: #333;
    margin-bottom: 8px;
}

.sr-matrix-subtitle {
    color: #666;
    font-size: 14px;
    margin: 0;
}

/* Summary Cards */
.sr-priority-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
}

.sr-summary-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    border-radius: 12px;
    color: white;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.sr-summary-card.sr-critical {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
}

.sr-summary-card.sr-quick-wins {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.sr-summary-card.sr-major-projects {
    background: linear-gradient(135deg, #fd7e14 0%, #e67e22 100%);
}

.sr-summary-card.sr-total {
    background: linear-gradient(135deg, #6f42c1 0%, #5a67d8 100%);
}

.sr-summary-icon {
    font-size: 24px;
    opacity: 0.9;
}

.sr-summary-number {
    font-size: 28px;
    font-weight: 700;
    line-height: 1;
}

.sr-summary-label {
    font-size: 12px;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Matrix Container */
.sr-matrix-container {
    margin: 32px 0;
    background: #f8f9fa;
    border-radius: 12px;
    padding: 24px;
}

.sr-matrix-wrapper {
    display: flex;
    gap: 16px;
}

.sr-y-axis {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 40px;
    color: #666;
    font-weight: 600;
    font-size: 12px;
}

.sr-matrix-area {
    flex: 1;
}

.sr-x-axis-label {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 16px;
    color: #666;
    font-weight: 600;
    font-size: 12px;
}

.sr-axis-scale {
    display: flex;
    justify-content: space-between;
    width: 100%;
    font-size: 10px;
    opacity: 0.7;
    margin-top: 8px;
}

/* Matrix Grid */
.sr-matrix-grid {
    position: relative;
    width: 100%;
    height: 400px;
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    background-image: 
        linear-gradient(rgba(0,0,0,.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,0,0,.1) 1px, transparent 1px);
    background-size: 50px 50px;
}

/* Quadrant Dividers */
.sr-matrix-grid::before {
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    width: 2px;
    height: 100%;
    background: #6c757d;
    z-index: 1;
}

.sr-matrix-grid::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    width: 100%;
    height: 2px;
    background: #6c757d;
    z-index: 1;
}

/* Quadrant Labels */
.sr-quadrant-label {
    position: absolute;
    padding: 8px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 6px;
    font-size: 12px;
    text-align: center;
    border: 1px solid #dee2e6;
    z-index: 2;
}

.sr-quadrant-label.sr-q1 {
    top: 8px;
    right: 8px;
}

.sr-quadrant-label.sr-q2 {
    bottom: 8px;
    right: 8px;
}

.sr-quadrant-label.sr-q3 {
    top: 8px;
    left: 8px;
}

.sr-quadrant-label.sr-q4 {
    bottom: 8px;
    left: 8px;
}

/* Issue Bubbles */
.sr-issue-bubble {
    position: absolute;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 10;
    transform: translate(-50%, 50%);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.sr-issue-bubble:hover {
    transform: translate(-50%, 50%) scale(1.2);
    z-index: 100;
}

.sr-issue-bubble.sr-priority-critical {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
}

.sr-issue-bubble.sr-priority-high {
    background: linear-gradient(135deg, #fd7e14, #e67e22);
    color: white;
}

.sr-issue-bubble.sr-priority-medium {
    background: linear-gradient(135deg, #ffc107, #ffb300);
    color: #333;
}

.sr-issue-bubble.sr-priority-low {
    background: linear-gradient(135deg, #6c757d, #5a6268);
    color: white;
}

.sr-bubble-content {
    font-size: 12px;
}

.sr-bubble-priority {
    position: absolute;
    top: -6px;
    right: -6px;
    background: #333;
    color: white;
    font-size: 8px;
    padding: 2px 4px;
    border-radius: 4px;
    font-weight: 600;
}

/* Issue Details Panel */
.sr-issue-details-panel {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 24px;
    margin-top: 24px;
    border: 1px solid #dee2e6;
}

.sr-issue-details-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid #dee2e6;
}

.sr-close-details {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: #6c757d;
}

.sr-detail-section {
    margin-bottom: 16px;
}

.sr-detail-section h5 {
    color: #333;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 600;
}

.sr-priority-badges {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.sr-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.sr-badge.sr-priority-critical {
    background: #dc3545;
    color: white;
}

.sr-badge.sr-priority-high {
    background: #fd7e14;
    color: white;
}

.sr-badge.sr-priority-medium {
    background: #ffc107;
    color: #333;
}

.sr-badge.sr-priority-low {
    background: #6c757d;
    color: white;
}

.sr-page-link {
    color: #0d6efd;
    text-decoration: none;
    font-size: 12px;
}

.sr-page-link:hover {
    text-decoration: underline;
}

/* Quadrant Lists */
.sr-quadrant-lists {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 24px;
    margin-top: 32px;
}

.sr-quadrant-title {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
    font-size: 18px;
    font-weight: 600;
}

.sr-quadrant-title.sr-quick-wins-title {
    color: #28a745;
}

.sr-quadrant-title.sr-major-projects-title {
    color: #fd7e14;
}

.sr-issue-item {
    display: flex;
    gap: 12px;
    padding: 16px;
    background: white;
    border-radius: 8px;
    margin-bottom: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border-left: 4px solid transparent;
}

.sr-issue-item.sr-quick-win {
    border-left-color: #28a745;
}

.sr-issue-item.sr-major-project {
    border-left-color: #fd7e14;
}

.sr-issue-priority {
    background: #333;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 12px;
    flex-shrink: 0;
}

.sr-issue-content {
    flex: 1;
}

.sr-issue-content strong {
    display: block;
    margin-bottom: 4px;
    color: #333;
}

.sr-issue-content p {
    color: #666;
    font-size: 13px;
    margin-bottom: 8px;
}

.sr-issue-meta {
    display: flex;
    gap: 12px;
    font-size: 11px;
}

.sr-category, .sr-complexity {
    padding: 2px 6px;
    background: #e9ecef;
    border-radius: 4px;
    color: #6c757d;
}

.sr-show-more {
    text-align: center;
    margin-top: 12px;
}

.sr-btn-link {
    background: none;
    border: none;
    color: #0d6efd;
    text-decoration: underline;
    cursor: pointer;
    font-size: 13px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .sr-matrix-wrapper {
        flex-direction: column;
    }
    
    .sr-y-axis {
        writing-mode: horizontal-tb;
        text-orientation: initial;
        width: auto;
        height: 30px;
    }
    
    .sr-matrix-grid {
        height: 300px;
    }
    
    .sr-quadrant-lists {
        grid-template-columns: 1fr;
    }
    
    .sr-priority-summary {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>